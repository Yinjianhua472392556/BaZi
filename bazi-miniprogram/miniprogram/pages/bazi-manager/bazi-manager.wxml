<!--bazi-manager.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="page-title">å…«å­—ç®¡ç†</view>
    <view class="page-subtitle">ç®¡ç†æ‚¨çš„å…«å­—è®°å½•å’Œè‡ªå®šä¹‰å¤‡æ³¨</view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    
    <!-- å…«å­—åˆ—è¡¨ -->
    <view class="bazi-list" wx:if="{{baziList.length > 0}}">
      <view class="bazi-item" wx:for="{{baziList}}" wx:key="fingerprint">
        <!-- å…«å­—ä¿¡æ¯å¤´éƒ¨ -->
        <view class="bazi-header">
          <view class="bazi-info">
            <view class="bazi-display-name">
              {{item.display_name}}
              <text class="primary-badge" wx:if="{{item.is_primary}}">ä¸»è¦</text>
            </view>
            <view class="bazi-pillars">
              {{item.bazi_result.year_pillar}} {{item.bazi_result.month_pillar}} 
              {{item.bazi_result.day_pillar}} {{item.bazi_result.hour_pillar}}
            </view>
            <view class="bazi-birth-info">
              {{item.birthInfo.date}} {{item.birthInfo.time}} 
              ({{item.birthInfo.gender === 'male' ? 'ç”·' : 'å¥³'}})
            </view>
          </view>
          <view class="bazi-actions">
            <button class="action-btn primary-btn" 
                    wx:if="{{!item.is_primary}}" 
                    bindtap="setPrimary" 
                    data-fingerprint="{{item.fingerprint}}">
              è®¾ä¸ºä¸»è¦
            </button>
            <button class="action-btn edit-btn" 
                    bindtap="editNote" 
                    data-fingerprint="{{item.fingerprint}}"
                    data-current-note="{{item.has_custom_note ? item.display_name : ''}}">
              {{item.has_custom_note ? 'ç¼–è¾‘å¤‡æ³¨' : 'æ·»åŠ å¤‡æ³¨'}}
            </button>
          </view>
        </view>

        <!-- è¿åŠ¿é¢„è§ˆ -->
        <view class="fortune-preview" wx:if="{{item.daily_fortune}}">
          <view class="fortune-score-row">
            <view class="score-item">
              <text class="score-label">ç»¼åˆ</text>
              <view class="stars">
                <text class="star {{index < item.daily_fortune.overall_score ? 'filled' : ''}}" 
                      wx:for="{{[1,2,3,4,5]}}" wx:key="index">â˜…</text>
              </view>
            </view>
            <view class="score-item">
              <text class="score-label">è´¢è¿</text>
              <text class="score-value">{{item.daily_fortune.detailed_scores.wealth}}åˆ†</text>
            </view>
            <view class="score-item">
              <text class="score-label">äº‹ä¸š</text>
              <text class="score-value">{{item.daily_fortune.detailed_scores.career}}åˆ†</text>
            </view>
            <view class="score-item">
              <text class="score-label">å¥åº·</text>
              <text class="score-value">{{item.daily_fortune.detailed_scores.health}}åˆ†</text>
            </view>
          </view>
          
          <!-- å¹¸è¿å…ƒç´  -->
          <view class="lucky-elements">
            <text class="lucky-item">å¹¸è¿è‰²: {{item.daily_fortune.lucky_elements.lucky_color}}</text>
            <text class="lucky-item">å¹¸è¿æ•°å­—: {{item.daily_fortune.lucky_elements.lucky_number}}</text>
            <text class="lucky-item">å¹¸è¿æ–¹ä½: {{item.daily_fortune.lucky_elements.lucky_direction}}</text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="item-actions">
          <button class="action-btn detail-btn" 
                  bindtap="viewDetail" 
                  data-fingerprint="{{item.fingerprint}}">
            æŸ¥çœ‹è¯¦æƒ…
          </button>
          <button class="action-btn delete-btn" 
                  bindtap="deleteNote" 
                  data-fingerprint="{{item.fingerprint}}"
                  wx:if="{{item.has_custom_note}}">
            åˆ é™¤å¤‡æ³¨
          </button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{baziList.length === 0}}">
      <view class="empty-icon">ğŸ“Š</view>
      <view class="empty-title">æš‚æ— å…«å­—è®°å½•</view>
      <view class="empty-desc">è¯·å…ˆåœ¨é¦–é¡µæµ‹ç®—å…«å­—</view>
      <button class="btn-primary" bindtap="goToHome">å»æµ‹ç®—å…«å­—</button>
    </view>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats-section" wx:if="{{baziList.length > 0}}">
      <view class="stats-title">ç»Ÿè®¡ä¿¡æ¯</view>
      <view class="stats-grid">
        <view class="stats-item">
          <view class="stats-number">{{baziList.length}}</view>
          <view class="stats-label">å…«å­—è®°å½•</view>
        </view>
        <view class="stats-item">
          <view class="stats-number">{{customNotesCount}}</view>
          <view class="stats-label">è‡ªå®šä¹‰å¤‡æ³¨</view>
        </view>
        <view class="stats-item">
          <view class="stats-number">{{todayDate}}</view>
          <view class="stats-label">ä»Šæ—¥æ—¥æœŸ</view>
        </view>
      </view>
    </view>

    <!-- ç®¡ç†æ“ä½œ -->
    <view class="management-actions" wx:if="{{baziList.length > 0}}">
      <button class="btn-secondary" bindtap="refreshAllFortunes">åˆ·æ–°æ‰€æœ‰è¿åŠ¿</button>
      <button class="btn-secondary" bindtap="exportData">å¯¼å‡ºæ•°æ®</button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘å¤‡æ³¨å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showEditModal}}" bindtap="closeEditModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <view class="modal-title">ç¼–è¾‘å¤‡æ³¨</view>
      <button class="close-btn" bindtap="closeEditModal">Ã—</button>
    </view>
    <view class="modal-body">
      <view class="input-group">
        <label class="input-label">è‡ªå®šä¹‰å¤‡æ³¨</label>
        <input class="input-field" 
               placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰å¤‡æ³¨ï¼ˆå¦‚ï¼šçˆ¸çˆ¸ã€å¦ˆå¦ˆã€è‡ªå·±ç­‰ï¼‰"
               value="{{currentNote}}"
               bindinput="onNoteInput"
               maxlength="20"/>
        <view class="input-hint">æœ€å¤š20ä¸ªå­—ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å…«å­—è®°å½•</view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeEditModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="saveNote">ä¿å­˜</button>
    </view>
  </view>
</view>
