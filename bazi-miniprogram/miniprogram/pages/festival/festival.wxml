<!--festival.wxml-->
<view class="container">
  <!-- 简化的页面头部 -->
  <view class="page-header">
    <view class="page-title-container">
      <view class="page-title">最近节日 🎊</view>
      <view class="page-subtitle">未来13个月 · 黄历宜忌</view>
    </view>
    <view class="page-decoration">☯︎</view>
  </view>

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 更新时间 -->
    <view wx:if="{{lastUpdateTime}}" class="update-time">
      最后更新：{{lastUpdateTime}}
    </view>
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载节日数据中...</text>
    </view>

    <!-- 错误状态 -->
    <view wx:elif="{{error}}" class="error-container">
      <view class="error-icon">⚠️</view>
      <text class="error-text">{{error}}</text>
      <button class="retry-button" bindtap="onRetry">重试</button>
    </view>

    <!-- 节日列表 -->
    <view wx:elif="{{festivals.length > 0}}" class="festival-list">
      <block wx:for="{{festivals}}" wx:key="id">
        <!-- 节日卡片 -->
        <view 
          class="festival-card {{item.popularityLevel}}"
          style="--primary-color: {{item.primaryColor}}; --accent-color: {{item.accentColor}};"
          data-festival="{{item}}"
          bindtap="onFestivalTap"
        >
          <!-- 卡片顶部装饰条 -->
          <view class="card-top-decoration" style="background: linear-gradient(90deg, {{item.primaryColor}}, {{item.accentColor}});"></view>
          
          <!-- 头部区域：节日名称和类型 -->
          <view class="festival-header">
            <view class="header-main">
              <view class="festival-title-section">
                <text class="festival-emoji">{{item.iconEmoji}}</text>
                <text class="festival-name" style="color: {{item.primaryColor}};">{{item.name}}</text>
                <view class="festival-type-tag" style="background: {{item.accentColor}};">{{item.typeDisplay}}</view>
              </view>
            </view>
          </view>
          
          <!-- 核心信息区：日期 + 倒计时突出显示 -->
          <view class="core-info">
            <view class="date-section">
              <view class="date-main">
                <text class="solar-date">{{item.date}}</text>
                <text class="day-of-week">{{item.dayOfWeek}}</text>
              </view>
              <view class="lunar-date-display" wx:if="{{item.lunarDate}}">
                <text class="lunar-text">{{item.lunarDate}}</text>
              </view>
            </view>
            <view class="countdown-section">
              <view class="countdown-circle" style="border-color: {{item.primaryColor}};">
                <text class="countdown-number" style="color: {{item.primaryColor}};">{{item.daysUntil}}</text>
                <text class="countdown-unit">天</text>
              </view>
              <text class="countdown-text">{{item.countdownText}}</text>
            </view>
          </view>
          
          <!-- 文化信息区：描述 + 习俗 -->
          <view class="cultural-info" wx:if="{{item.description}}">
            <view class="description-section">
              <text class="festival-description">{{item.description}}</text>
            </view>
            <view class="customs-section" wx:if="{{item.customs && item.customs.length > 0}}">
              <text class="customs-label">主要习俗：</text>
              <view class="customs-tags">
                <text 
                  wx:for="{{item.customs}}" 
                  wx:for-item="custom"
                  wx:key="*this" 
                  class="custom-tag"
                  style="background: {{item.accentColor}};"
                >
                  {{custom}}
                </text>
              </view>
            </view>
          </view>
          
          <!-- 传统信息区：可折叠 -->
          <view class="traditional-info" wx:if="{{!item.isolarTerm}}">
            <view class="traditional-header">
              <text class="traditional-title">传统信息</text>
              <text class="traditional-toggle">👁️</text>
            </view>
            <view class="traditional-content">
              <view class="info-grid">
                <view class="info-item" wx:if="{{item.ganZhi}}">
                  <text class="info-label">值神</text>
                  <text class="info-value">{{item.ganZhi}}</text>
                </view>
                <view class="info-item" wx:if="{{item.shierShen}}">
                  <text class="info-label">十二神</text>
                  <text class="info-value">{{item.shierShen}}</text>
                </view>
                <view class="info-item full-width" wx:if="{{item.xingXiu}}">
                  <text class="info-label">星宿</text>
                  <text class="info-value">{{item.xingXiu}}</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 宜忌活动区：优化布局 -->
          <view class="activities-section" wx:if="{{item.activities && (item.activities.suitable.length > 0 || item.activities.unsuitable.length > 0)}}">
            <view class="activities-header">
              <text class="activities-title">宜忌活动</text>
            </view>
            <view class="activities-content">
              <view class="activity-group" wx:if="{{item.activities.suitable && item.activities.suitable.length > 0}}">
                <view class="activity-label suitable">
                  <text class="label-icon">✓</text>
                  <text class="label-text">宜</text>
                </view>
                <view class="activity-tags">
                  <text 
                    wx:for="{{item.activities.suitable}}" 
                    wx:for-item="activity"
                    wx:key="*this" 
                    class="activity-tag suitable-tag"
                  >
                    {{activity}}
                  </text>
                </view>
              </view>
              <view class="activity-group" wx:if="{{item.activities.unsuitable && item.activities.unsuitable.length > 0}}">
                <view class="activity-label unsuitable">
                  <text class="label-icon">✗</text>
                  <text class="label-text">忌</text>
                </view>
                <view class="activity-tags">
                  <text 
                    wx:for="{{item.activities.unsuitable}}" 
                    wx:for-item="activity"
                    wx:key="*this" 
                    class="activity-tag unsuitable-tag"
                  >
                    {{activity}}
                  </text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 重要程度指示器 -->
          <view class="importance-indicator {{item.popularityLevel}}" wx:if="{{item.popularityLevel === 'popular'}}">
            <text class="importance-icon">⭐</text>
          </view>
        </view>

        <!-- 5. 节日列表中的原生广告 - 每3个节日后插入一个广告 -->
        <ad-native 
          wx:if="{{(index + 1) % 3 === 0 && index < festivals.length - 1}}"
          ad-type="native"
          page-name="festival"
          show-close-button="{{true}}"
          bind:adload="onNativeAdLoad"
          bind:adclick="onNativeAdClick"
          bind:adclose="onNativeAdClose"
          bind:aderror="onNativeAdError">
        </ad-native>
      </block>
    </view>

    <!-- 空状态 -->
    <view wx:else class="empty-container">
      <view class="empty-icon">📅</view>
      <text class="empty-text">暂无节日数据</text>
      <button class="retry-button" bindtap="onRetry">重新加载</button>
    </view>

    <!-- 底部说明 -->
    <view wx:if="{{festivals.length > 0}}" class="disclaimer">
      <text class="disclaimer-text">
        * 传统历法结合现代天文算法，提供精准的节日信息，宜忌内容仅供参考
      </text>
    </view>
  </view>
</view>
