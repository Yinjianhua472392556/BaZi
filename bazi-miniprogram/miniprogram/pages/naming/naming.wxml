<view class="container">
  <view class="page-header">
    <view class="page-title-container">
      <view class="page-title">æ™ºèƒ½èµ·å</view>
      <view class="page-subtitle">åŸºäºå…«å­—äº”è¡Œçš„ä¸“ä¸šèµ·å</view>
    </view>
    <view class="page-decoration">ğŸŒŸ</view>
  </view>

  <view class="main-content" wx:if="{{!showResults}}">
    <view class="card">
      <view class="subtitle">è¯·è¾“å…¥æ‚¨çš„åŸºæœ¬ä¿¡æ¯</view>
      
      <view class="form-group">
        <view class="form-title">åŸºæœ¬ä¿¡æ¯</view>
        
        <view class="input-row">
          <view class="input-label">å§“æ°</view>
          <input 
            class="input-field" 
            placeholder="è¯·è¾“å…¥å§“æ°"
            value="{{surname}}"
            bindinput="onSurnameInput"
            maxlength="3"
            cursor-spacing="50"
            show-confirm-bar="{{false}}"
            adjust-position="{{false}}"
            confirm-type="done"
            selection-start="-1"
            selection-end="-1"
            hold-keyboard="{{false}}"
            safe-password-cert-path=""
            safe-password-length=""
            safe-password-time-stamp=""
            safe-password-nonce=""
            safe-password-salt=""
            safe-password-custom-hash=""
            always-embed="{{false}}"
            always-system="{{false}}"
          />
        </view>

        <view class="input-row">
          <view class="input-label">æ€§åˆ«</view>
          <picker 
            bindchange="onGenderChange" 
            range="{{genderOptions}}"
            range-key="text"
            value="{{genderIndex}}"
          >
            <view class="picker-display">
              {{genderOptions[genderIndex].text}}
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <view class="form-group">
        <view class="form-title">å‡ºç”Ÿä¿¡æ¯</view>
        
        <!-- æ—¥å†ç±»å‹é€‰æ‹© -->
        <view class="input-row">
          <view class="input-label">æ—¥æœŸç±»å‹</view>
          <radio-group bindchange="onCalendarTypeChange">
            <label class="radio-item">
              <radio value="solar" checked="{{calendarType === 'solar'}}" color="#C8860D"/>
              å…¬å†
            </label>
            <label class="radio-item">
              <radio value="lunar" checked="{{calendarType === 'lunar'}}" color="#C8860D"/>
              å†œå†
            </label>
          </radio-group>
        </view>

        <!-- å‡ºç”Ÿæ—¥æœŸé€‰æ‹© -->
        <view class="input-row">
          <view class="input-label">å‡ºç”Ÿæ—¥æœŸ</view>
          
          <!-- å…¬å†æ—¥æœŸé€‰æ‹©å™¨ -->
          <view wx:if="{{calendarType === 'solar'}}" class="date-picker-container">
            <picker mode="date" value="{{birthDate}}" start="1900-01-01" end="{{maxDate}}" bindchange="onDateChange">
              <view class="picker">
                {{birthDate || 'è¯·é€‰æ‹©å…¬å†å‡ºç”Ÿæ—¥æœŸ'}}
              </view>
            </picker>
            <view class="date-type-hint">
              é€‰æ‹©å…¬å†æ—¥æœŸï¼ˆå¦‚ï¼š1990-01-15ï¼‰
              <view wx:if="{{birthDate && correspondingLunarDate}}" class="corresponding-date">
                å¯¹åº”å†œå†ï¼š{{correspondingLunarDate}}
              </view>
            </view>
          </view>
          
          <!-- å†œå†æ—¥æœŸé€‰æ‹©å™¨ -->
          <view wx:else class="date-picker-container">
            <view class="lunar-date-pickers">
              <!-- å†œå†å¹´é€‰æ‹©å™¨ -->
              <picker class="lunar-year-picker" value="{{lunarYearIndex}}" range="{{lunarYears}}" bindchange="onLunarYearChange">
                <view class="picker">
                  {{lunarYear || 'å¹´'}}
                </view>
              </picker>
              
              <!-- å†œå†æœˆé€‰æ‹©å™¨ -->
              <picker class="lunar-month-picker" value="{{lunarMonthIndex}}" range="{{lunarMonths}}" bindchange="onLunarMonthChange">
                <view class="picker">
                  {{lunarMonth || 'æœˆ'}}
                </view>
              </picker>
              
              <!-- å†œå†æ—¥é€‰æ‹©å™¨ -->
              <picker class="lunar-day-picker" value="{{lunarDayIndex}}" range="{{lunarDays}}" bindchange="onLunarDayChange">
                <view class="picker">
                  {{lunarDay || 'æ—¥'}}
                </view>
              </picker>
            </view>
            
            <view class="date-type-hint">
              é€‰æ‹©å†œå†æ—¥æœŸ
              <view wx:if="{{lunarYear && lunarMonth && lunarDay && correspondingSolarDate}}" class="corresponding-date">
                å¯¹åº”å…¬å†ï¼š{{correspondingSolarDate}}
              </view>
            </view>
          </view>
        </view>

        <!-- å‡ºç”Ÿæ—¶é—´é€‰æ‹© -->
        <view class="input-row">
          <view class="input-label">å‡ºç”Ÿæ—¶é—´</view>
          <picker mode="time" value="{{birthTime}}" bindchange="onTimeChange">
            <view class="picker">
              {{birthTime || 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¶é—´'}}
            </view>
          </picker>
        </view>
      </view>

      <view class="form-group">
        <view class="form-title">èµ·ååå¥½</view>
        
        <view class="input-row">
          <view class="input-label">å­—æ•°</view>
          <picker 
            bindchange="onNameLengthChange" 
            range="{{nameLengthOptions}}"
            range-key="text"
            value="{{nameLengthIndex}}"
          >
            <view class="picker-display">
              {{nameLengthOptions[nameLengthIndex].text}}
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <view class="input-row">
          <view class="input-label">ç”Ÿæˆæ•°é‡</view>
          <picker 
            bindchange="onNameCountChange" 
            range="{{nameCountOptions}}"
            range-key="text"
            value="{{nameCountIndex}}"
          >
            <view class="picker-display">
              {{nameCountOptions[nameCountIndex].text}}
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <!-- ä¸ªæ€§åŒ–åå¥½è®¾ç½® -->
        <view class="preference-section">
          <view class="preference-title" bindtap="togglePreferences">
            <text>ä¸ªæ€§åŒ–åå¥½è®¾ç½®</text>
            <text class="toggle-icon">{{showPreferences ? 'â–²' : 'â–¼'}}</text>
          </view>
          
          <view class="preferences-content" wx:if="{{showPreferences}}">
            <!-- æ–‡åŒ–å±‚æ¬¡åå¥½ -->
            <view class="preference-item">
              <view class="preference-label">æ–‡åŒ–é£æ ¼</view>
              <picker 
                bindchange="onCulturalLevelChange" 
                range="{{culturalLevelOptions}}"
                range-key="text"
                value="{{culturalLevelIndex}}"
              >
                <view class="preference-picker">
                  {{culturalLevelOptions[culturalLevelIndex].text}}
                  <text class="picker-arrow">â–¼</text>
                </view>
              </picker>
            </view>

            <!-- æµè¡Œåº¦åå¥½ -->
            <view class="preference-item">
              <view class="preference-label">æµè¡Œç¨‹åº¦</view>
              <picker 
                bindchange="onPopularityChange" 
                range="{{popularityOptions}}"
                range-key="text"
                value="{{popularityIndex}}"
              >
                <view class="preference-picker">
                  {{popularityOptions[popularityIndex].text}}
                  <text class="picker-arrow">â–¼</text>
                </view>
              </picker>
            </view>

            <!-- æ—¶ä»£ç‰¹å¾åå¥½ -->
            <view class="preference-item">
              <view class="preference-label">æ—¶ä»£ç‰¹å¾</view>
              <picker 
                bindchange="onEraChange" 
                range="{{eraOptions}}"
                range-key="text"
                value="{{eraIndex}}"
              >
                <view class="preference-picker">
                  {{eraOptions[eraIndex].text}}
                  <text class="picker-arrow">â–¼</text>
                </view>
              </picker>
            </view>

            <!-- å­—çš„ç¨€æœ‰åº¦åå¥½ -->
            <view class="preference-item">
              <view class="preference-label">å­—çš„ç¨€æœ‰åº¦</view>
              <picker 
                bindchange="onRarityChange" 
                range="{{rarityOptions}}"
                range-key="text"
                value="{{rarityIndex}}"
              >
                <view class="preference-picker">
                  {{rarityOptions[rarityIndex].text}}
                  <text class="picker-arrow">â–¼</text>
                </view>
              </picker>
            </view>

            <!-- ä¸ªæ€§åŒ–æœç´¢åŠŸèƒ½ -->
            <view class="preference-item">
              <view class="preference-label">å­—ä¹‰åå¥½</view>
              <view class="meaning-search">
                <input 
                  class="meaning-input" 
                  placeholder="å¦‚ï¼šæ™ºæ…§ã€ç¾å¥½ã€æˆåŠŸç­‰"
                  value="{{meaningKeyword}}"
                  bindinput="onMeaningInput"
                  bindblur="searchCharactersByMeaning"
                />
                <button 
                  class="search-btn"
                  bindtap="searchCharactersByMeaning"
                  disabled="{{!meaningKeyword}}"
                >
                  æœç´¢
                </button>
              </view>
              
              <!-- å­—ä¹‰æœç´¢ç»“æœ -->
              <view class="meaning-results" wx:if="{{meaningSearchResults.length > 0}}">
                <view class="results-title">ç›¸å…³æ¨èå­—ï¼š</view>
                <view class="character-tags">
                  <view 
                    class="character-tag {{item.selected ? 'selected' : ''}}"
                    wx:for="{{meaningSearchResults}}"
                    wx:key="char"
                    bindtap="toggleCharacterSelection"
                    data-char="{{item.char}}"
                  >
                    {{item.char}}
                    <text class="char-meaning">{{item.meaning}}</text>
                  </view>
                </view>
              </view>
            </view>

            <!-- åå¥½é‡ç½® -->
            <view class="preference-actions">
              <button class="reset-preferences-btn" bindtap="resetPreferences">
                é‡ç½®åå¥½
              </button>
            </view>
          </view>
        </view>
      </view>

      <view class="action-section">
        <button 
          class="start-naming-btn {{analyzing ? 'loading' : ''}}"
          bindtap="startNaming"
          disabled="{{!canNaming || analyzing}}"
        >
          <text wx:if="{{!analyzing}}">å¼€å§‹èµ·å</text>
          <text wx:else>æ­£åœ¨åˆ†æä¸­...</text>
        </button>
      </view>
    </view>

    <!-- å…è´£å£°æ˜ -->
    <view class="disclaimer">
      æœ¬å°ç¨‹åºåŸºäºä¼ ç»Ÿæ–‡åŒ–å¼€å‘ï¼Œæ‰€æœ‰æµ‹ç®—ç»“æœä»…ä¾›å¨±ä¹å‚è€ƒã€‚
    </view>
  </view>

  <view class="results-section" wx:if="{{showResults}}">
    <view class="analysis-card">
      <view class="analysis-title">å…«å­—äº”è¡Œåˆ†æ</view>
      <view class="analysis-content">{{analysisSummary}}</view>
      <view class="naming-suggestions">{{namingSuggestions}}</view>
    </view>

    <view class="names-list">
      <view class="list-title">æ¨èåå­—</view>
      
      <!-- è¯„åˆ†è¯´æ˜ -->
      <view class="score-legend">
        <view class="legend-title">è¯„åˆ†è¯´æ˜</view>
        <view class="legend-items">
          <view class="legend-item">
            <view class="legend-badge score-excellent">90+</view>
            <text>ä¼˜ç§€</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-good">80-89</view>
            <text>è‰¯å¥½</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-average">70-79</view>
            <text>ä¸€èˆ¬</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-below">60-69</view>
            <text>åä½</text>
          </view>
        </view>
      </view>
      
      <view 
        class="name-item"
        wx:for="{{recommendations}}"
        wx:key="full_name"
        bindtap="viewNameDetail"
        data-index="{{index}}"
      >
        <view class="name-main">
          <view class="name-text">{{item.full_name}}</view>
          <view class="name-score">
            <text class="score-number">{{item.overall_score}}</text>
            <text class="score-label">åˆ†</text>
          </view>
        </view>
        <view class="name-info">
          <view class="name-pronunciation">{{item.pronunciation}}</view>
          <view class="name-luck">{{item.luck_level}}</view>
        </view>
        <view class="name-meaning">{{item.meaning_explanation}}</view>
        
        <view class="name-actions">
          <button 
            class="action-btn collect-btn"
            catchtap="collectName"
            data-index="{{index}}"
          >
            æ”¶è—
          </button>
          <button 
            class="action-btn share-btn"
            catchtap="showShareOptions"
            data-index="{{index}}"
          >
            åˆ†äº«
          </button>
        </view>
      </view>

      <!-- åŸç”Ÿå¹¿å‘Š - å·²éšè—ï¼ˆå¾®ä¿¡å¹¿å‘Šç³»ç»Ÿè‡ªå·±é›†æˆï¼‰ -->
    </view>

    <view class="restart-section">
      <button class="restart-btn" bindtap="restartNaming">
        é‡æ–°èµ·å
      </button>
    </view>
  </view>

  <view class="name-detail-modal" wx:if="{{showNameDetail}}" bindtap="closeNameDetail">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <view class="modal-title">{{selectedName.full_name}}</view>
        <view class="modal-close" bindtap="closeNameDetail">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="detail-row">
            <text class="detail-label">å®Œæ•´å§“åï¼š</text>
            <text class="detail-value">{{selectedName.full_name}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æ‹¼éŸ³ï¼š</text>
            <text class="detail-value">{{selectedName.pronunciation}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">ç»¼åˆè¯„åˆ†ï¼š</text>
            <text class="detail-value score">{{selectedName.overall_score}}åˆ†</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">å‰å‡¶ç­‰çº§ï¼š</text>
            <text class="detail-value luck">{{selectedName.luck_level}}</text>
          </view>
        </view>

        <!-- è¯„åˆ†ç»†é¡¹åˆ†æ -->
        <view class="detail-section">
          <view class="detail-title">è¯„åˆ†æ„æˆåˆ†æ</view>
          <view class="score-breakdown" wx:if="{{selectedName.score_breakdown}}">
            <view class="score-item">
              <view class="score-item-name">äº”æ ¼å¾—åˆ† ({{selectedName.score_breakdown.weights.wuge_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.wuge_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.wuge_score}}åˆ†</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">äº”è¡ŒåŒ¹é… ({{selectedName.score_breakdown.weights.wuxing_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.wuxing_match_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.wuxing_match_score}}åˆ†</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">ä¸‰æ‰é…ç½® ({{selectedName.score_breakdown.weights.sancai_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.sancai_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.sancai_score}}åˆ†</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">éŸ³éŸµå’Œè° ({{selectedName.score_breakdown.weights.phonetic_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.phonetic_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.phonetic_score}}åˆ†</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">å¯“æ„å†…æ¶µ ({{selectedName.score_breakdown.weights.meaning_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.meaning_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.meaning_score}}åˆ†</view>
            </view>
          </view>
          
          
          <!-- é™çº§æ˜¾ç¤ºï¼šå¦‚æœæ²¡æœ‰score_breakdownæ•°æ® -->
          <view class="score-breakdown-fallback" wx:else>
            <view class="fallback-notice">è¯¦ç»†è¯„åˆ†æ•°æ®åŠ è½½ä¸­...</view>
            <view class="score-item">
              <view class="score-item-name">ç»¼åˆè¯„åˆ†</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.overall_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.overall_score}}åˆ†</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">äº”è¡Œåˆ†æ</view>
          <view class="wuxing-chars">
            <view 
              class="wuxing-char"
              wx:for="{{selectedName.wuxing_analysis.chars_wuxing}}"
              wx:key="char"
            >
              <view class="char-text">{{item.char}}</view>
              <view class="char-wuxing">{{item.wuxing}}</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">ä¸‰æ‰äº”æ ¼</view>
          <view class="wuge-grid">
            <view 
              class="wuge-item"
              wx:for="{{selectedName.sancai_wuge.wuge_analysis}}"
              wx:for-item="wuge"
              wx:for-index="wugeName"
              wx:key="*this"
            >
              <view class="wuge-name">{{wugeName}}</view>
              <view class="wuge-value">{{wuge.value}}</view>
              <view class="wuge-wuxing">{{wuge.wuxing}}</view>
              <view class="wuge-luck">{{wuge.luck.luck}}</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">å¯“æ„è§£é‡Š</view>
          <view class="meaning-text">{{selectedName.meaning_explanation}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†äº«é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
  <view class="share-modal" wx:if="{{showShareModal}}" bindtap="closeShareModal">
    <view class="share-modal-content" catchtap="true">
      <view class="share-modal-header">
        <view class="share-modal-title">åˆ†äº«åˆ°</view>
        <view class="share-modal-close" bindtap="closeShareModal">Ã—</view>
      </view>
      
      <view class="share-options">
        <button 
          class="share-option share-friend-btn" 
          open-type="share"
          bindtap="prepareShareToFriend"
        >
          <view class="share-icon">ğŸ’¬</view>
          <view class="share-text">å¾®ä¿¡å¥½å‹</view>
        </button>
        <view class="share-option" bindtap="shareToTimeline">
          <view class="share-icon">ğŸ‘¥</view>
          <view class="share-text">æœ‹å‹åœˆ</view>
        </view>
      </view>
    </view>
  </view>

  <view class="disclaimer" wx:if="{{showResults}}">
    <text class="disclaimer-text">
      æœ¬å°ç¨‹åºåŸºäºä¼ ç»Ÿæ–‡åŒ–å¼€å‘ï¼Œæ‰€æœ‰æµ‹ç®—ç»“æœä»…ä¾›å¨±ä¹å‚è€ƒã€‚
    </text>
  </view>
</view>
