<view class="container">
  <view class="page-header">
    <view class="page-title-container">
      <view class="page-title">智能起名</view>
      <view class="page-subtitle">基于八字五行的专业起名</view>
    </view>
    <view class="page-decoration">🌟</view>
  </view>

  <view class="main-content" wx:if="{{!showResults}}">
    <view class="card">
      <view class="subtitle">请输入您的基本信息</view>
      
      <view class="form-group">
        <view class="form-title">基本信息</view>
        
        <view class="input-row">
          <view class="input-label">姓氏</view>
          <input 
            class="input-field" 
            placeholder="请输入姓氏"
            value="{{surname}}"
            bindinput="onSurnameInput"
            maxlength="3"
            cursor-spacing="50"
            show-confirm-bar="{{false}}"
            adjust-position="{{false}}"
            confirm-type="done"
            selection-start="-1"
            selection-end="-1"
            hold-keyboard="{{false}}"
            safe-password-cert-path=""
            safe-password-length=""
            safe-password-time-stamp=""
            safe-password-nonce=""
            safe-password-salt=""
            safe-password-custom-hash=""
            always-embed="{{false}}"
            always-system="{{false}}"
          />
        </view>

        <view class="input-row">
          <view class="input-label">性别</view>
          <picker 
            bindchange="onGenderChange" 
            range="{{genderOptions}}"
            range-key="text"
            value="{{genderIndex}}"
          >
            <view class="picker-display">
              {{genderOptions[genderIndex].text}}
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
      </view>

      <view class="form-group">
        <view class="form-title">出生信息</view>
        
        <!-- 日历类型选择 -->
        <view class="input-row">
          <view class="input-label">日期类型</view>
          <radio-group bindchange="onCalendarTypeChange">
            <label class="radio-item">
              <radio value="solar" checked="{{calendarType === 'solar'}}" color="#C8860D"/>
              公历
            </label>
            <label class="radio-item">
              <radio value="lunar" checked="{{calendarType === 'lunar'}}" color="#C8860D"/>
              农历
            </label>
          </radio-group>
        </view>

        <!-- 出生日期选择 -->
        <view class="input-row">
          <view class="input-label">出生日期</view>
          
          <!-- 公历日期选择器 -->
          <view wx:if="{{calendarType === 'solar'}}" class="date-picker-container">
            <picker mode="date" value="{{birthDate}}" start="1900-01-01" end="{{maxDate}}" bindchange="onDateChange">
              <view class="picker">
                {{birthDate || '请选择公历出生日期'}}
              </view>
            </picker>
            <view class="date-type-hint">
              选择公历日期（如：1990-01-15）
              <view wx:if="{{birthDate && correspondingLunarDate}}" class="corresponding-date">
                对应农历：{{correspondingLunarDate}}
              </view>
            </view>
          </view>
          
          <!-- 农历日期选择器 -->
          <view wx:else class="date-picker-container">
            <view class="lunar-date-pickers">
              <!-- 农历年选择器 -->
              <picker class="lunar-year-picker" value="{{lunarYearIndex}}" range="{{lunarYears}}" bindchange="onLunarYearChange">
                <view class="picker">
                  {{lunarYear || '年'}}
                </view>
              </picker>
              
              <!-- 农历月选择器 -->
              <picker class="lunar-month-picker" value="{{lunarMonthIndex}}" range="{{lunarMonths}}" bindchange="onLunarMonthChange">
                <view class="picker">
                  {{lunarMonth || '月'}}
                </view>
              </picker>
              
              <!-- 农历日选择器 -->
              <picker class="lunar-day-picker" value="{{lunarDayIndex}}" range="{{lunarDays}}" bindchange="onLunarDayChange">
                <view class="picker">
                  {{lunarDay || '日'}}
                </view>
              </picker>
            </view>
            
            <view class="date-type-hint">
              选择农历日期
              <view wx:if="{{lunarYear && lunarMonth && lunarDay && correspondingSolarDate}}" class="corresponding-date">
                对应公历：{{correspondingSolarDate}}
              </view>
            </view>
          </view>
        </view>

        <!-- 出生时间选择 -->
        <view class="input-row">
          <view class="input-label">出生时间</view>
          <picker mode="time" value="{{birthTime}}" bindchange="onTimeChange">
            <view class="picker">
              {{birthTime || '请选择出生时间'}}
            </view>
          </picker>
        </view>
      </view>

      <view class="form-group">
        <view class="form-title">起名偏好</view>
        
        <view class="input-row">
          <view class="input-label">字数</view>
          <picker 
            bindchange="onNameLengthChange" 
            range="{{nameLengthOptions}}"
            range-key="text"
            value="{{nameLengthIndex}}"
          >
            <view class="picker-display">
              {{nameLengthOptions[nameLengthIndex].text}}
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>

        <view class="input-row">
          <view class="input-label">生成数量</view>
          <picker 
            bindchange="onNameCountChange" 
            range="{{nameCountOptions}}"
            range-key="text"
            value="{{nameCountIndex}}"
          >
            <view class="picker-display">
              {{nameCountOptions[nameCountIndex].text}}
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>

        <!-- 个性化偏好设置 -->
        <view class="preference-section">
          <view class="preference-title" bindtap="togglePreferences">
            <text>个性化偏好设置</text>
            <text class="toggle-icon">{{showPreferences ? '▲' : '▼'}}</text>
          </view>
          
          <view class="preferences-content" wx:if="{{showPreferences}}">
            <!-- 文化层次偏好 -->
            <view class="preference-item">
              <view class="preference-label">文化风格</view>
              <picker 
                bindchange="onCulturalLevelChange" 
                range="{{culturalLevelOptions}}"
                range-key="text"
                value="{{culturalLevelIndex}}"
              >
                <view class="preference-picker">
                  {{culturalLevelOptions[culturalLevelIndex].text}}
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <!-- 流行度偏好 -->
            <view class="preference-item">
              <view class="preference-label">流行程度</view>
              <picker 
                bindchange="onPopularityChange" 
                range="{{popularityOptions}}"
                range-key="text"
                value="{{popularityIndex}}"
              >
                <view class="preference-picker">
                  {{popularityOptions[popularityIndex].text}}
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <!-- 时代特征偏好 -->
            <view class="preference-item">
              <view class="preference-label">时代特征</view>
              <picker 
                bindchange="onEraChange" 
                range="{{eraOptions}}"
                range-key="text"
                value="{{eraIndex}}"
              >
                <view class="preference-picker">
                  {{eraOptions[eraIndex].text}}
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <!-- 字的稀有度偏好 -->
            <view class="preference-item">
              <view class="preference-label">字的稀有度</view>
              <picker 
                bindchange="onRarityChange" 
                range="{{rarityOptions}}"
                range-key="text"
                value="{{rarityIndex}}"
              >
                <view class="preference-picker">
                  {{rarityOptions[rarityIndex].text}}
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <!-- 个性化搜索功能 -->
            <view class="preference-item">
              <view class="preference-label">字义偏好</view>
              <view class="meaning-search">
                <input 
                  class="meaning-input" 
                  placeholder="如：智慧、美好、成功等"
                  value="{{meaningKeyword}}"
                  bindinput="onMeaningInput"
                  bindblur="searchCharactersByMeaning"
                />
                <button 
                  class="search-btn"
                  bindtap="searchCharactersByMeaning"
                  disabled="{{!meaningKeyword}}"
                >
                  搜索
                </button>
              </view>
              
              <!-- 字义搜索结果 -->
              <view class="meaning-results" wx:if="{{meaningSearchResults.length > 0}}">
                <view class="results-title">相关推荐字：</view>
                <view class="character-tags">
                  <view 
                    class="character-tag {{item.selected ? 'selected' : ''}}"
                    wx:for="{{meaningSearchResults}}"
                    wx:key="char"
                    bindtap="toggleCharacterSelection"
                    data-char="{{item.char}}"
                  >
                    {{item.char}}
                    <text class="char-meaning">{{item.meaning}}</text>
                  </view>
                </view>
              </view>
            </view>

            <!-- 偏好重置 -->
            <view class="preference-actions">
              <button class="reset-preferences-btn" bindtap="resetPreferences">
                重置偏好
              </button>
            </view>
          </view>
        </view>
      </view>

      <view class="action-section">
        <button 
          class="start-naming-btn {{analyzing ? 'loading' : ''}}"
          bindtap="startNaming"
          disabled="{{!canNaming || analyzing}}"
        >
          <text wx:if="{{!analyzing}}">开始起名</text>
          <text wx:else>正在分析中...</text>
        </button>
      </view>
    </view>

    <!-- 免责声明 -->
    <view class="disclaimer">
      本小程序基于传统文化开发，所有测算结果仅供娱乐参考。
    </view>
  </view>

  <view class="results-section" wx:if="{{showResults}}">
    <view class="analysis-card">
      <view class="analysis-title">八字五行分析</view>
      <view class="analysis-content">{{analysisSummary}}</view>
      <view class="naming-suggestions">{{namingSuggestions}}</view>
    </view>

    <view class="names-list">
      <view class="list-title">推荐名字</view>
      
      <!-- 评分说明 -->
      <view class="score-legend">
        <view class="legend-title">评分说明</view>
        <view class="legend-items">
          <view class="legend-item">
            <view class="legend-badge score-excellent">90+</view>
            <text>优秀</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-good">80-89</view>
            <text>良好</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-average">70-79</view>
            <text>一般</text>
          </view>
          <view class="legend-item">
            <view class="legend-badge score-below">60-69</view>
            <text>偏低</text>
          </view>
        </view>
      </view>
      
      <view 
        class="name-item"
        wx:for="{{recommendations}}"
        wx:key="full_name"
        bindtap="viewNameDetail"
        data-index="{{index}}"
      >
        <view class="name-main">
          <view class="name-text">{{item.full_name}}</view>
          <view class="name-score">
            <text class="score-number">{{item.overall_score}}</text>
            <text class="score-label">分</text>
          </view>
        </view>
        <view class="name-info">
          <view class="name-pronunciation">{{item.pronunciation}}</view>
          <view class="name-luck">{{item.luck_level}}</view>
        </view>
        <view class="name-meaning">{{item.meaning_explanation}}</view>
        
        <view class="name-actions">
          <button 
            class="action-btn collect-btn"
            catchtap="collectName"
            data-index="{{index}}"
          >
            收藏
          </button>
          <button 
            class="action-btn share-btn"
            catchtap="showShareOptions"
            data-index="{{index}}"
          >
            分享
          </button>
        </view>
      </view>

      <!-- 原生广告 - 已隐藏（微信广告系统自己集成） -->
    </view>

    <view class="restart-section">
      <button class="restart-btn" bindtap="restartNaming">
        重新起名
      </button>
    </view>
  </view>

  <view class="name-detail-modal" wx:if="{{showNameDetail}}" bindtap="closeNameDetail">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <view class="modal-title">{{selectedName.full_name}}</view>
        <view class="modal-close" bindtap="closeNameDetail">×</view>
      </view>
      
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-title">基本信息</view>
          <view class="detail-row">
            <text class="detail-label">完整姓名：</text>
            <text class="detail-value">{{selectedName.full_name}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">拼音：</text>
            <text class="detail-value">{{selectedName.pronunciation}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">综合评分：</text>
            <text class="detail-value score">{{selectedName.overall_score}}分</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">吉凶等级：</text>
            <text class="detail-value luck">{{selectedName.luck_level}}</text>
          </view>
        </view>

        <!-- 评分细项分析 -->
        <view class="detail-section">
          <view class="detail-title">评分构成分析</view>
          <view class="score-breakdown" wx:if="{{selectedName.score_breakdown}}">
            <view class="score-item">
              <view class="score-item-name">五格得分 ({{selectedName.score_breakdown.weights.wuge_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.wuge_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.wuge_score}}分</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">五行匹配 ({{selectedName.score_breakdown.weights.wuxing_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.wuxing_match_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.wuxing_match_score}}分</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">三才配置 ({{selectedName.score_breakdown.weights.sancai_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.sancai_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.sancai_score}}分</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">音韵和谐 ({{selectedName.score_breakdown.weights.phonetic_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.phonetic_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.phonetic_score}}分</view>
            </view>
            <view class="score-item">
              <view class="score-item-name">寓意内涵 ({{selectedName.score_breakdown.weights.meaning_weight}}%)</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.score_breakdown.meaning_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.score_breakdown.meaning_score}}分</view>
            </view>
          </view>
          
          
          <!-- 降级显示：如果没有score_breakdown数据 -->
          <view class="score-breakdown-fallback" wx:else>
            <view class="fallback-notice">详细评分数据加载中...</view>
            <view class="score-item">
              <view class="score-item-name">综合评分</view>
              <view class="score-item-bar">
                <view class="score-bar-bg">
                  <view class="score-bar-fill" style="width: {{selectedName.overall_score}}%"></view>
                </view>
              </view>
              <view class="score-item-value">{{selectedName.overall_score}}分</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">五行分析</view>
          <view class="wuxing-chars">
            <view 
              class="wuxing-char"
              wx:for="{{selectedName.wuxing_analysis.chars_wuxing}}"
              wx:key="char"
            >
              <view class="char-text">{{item.char}}</view>
              <view class="char-wuxing">{{item.wuxing}}</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">三才五格</view>
          <view class="wuge-grid">
            <view 
              class="wuge-item"
              wx:for="{{selectedName.sancai_wuge.wuge_analysis}}"
              wx:for-item="wuge"
              wx:for-index="wugeName"
              wx:key="*this"
            >
              <view class="wuge-name">{{wugeName}}</view>
              <view class="wuge-value">{{wuge.value}}</view>
              <view class="wuge-wuxing">{{wuge.wuxing}}</view>
              <view class="wuge-luck">{{wuge.luck.luck}}</view>
            </view>
          </view>
        </view>

        <view class="detail-section">
          <view class="detail-title">寓意解释</view>
          <view class="meaning-text">{{selectedName.meaning_explanation}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 分享选择器模态框 -->
  <view class="share-modal" wx:if="{{showShareModal}}" bindtap="closeShareModal">
    <view class="share-modal-content" catchtap="true">
      <view class="share-modal-header">
        <view class="share-modal-title">分享到</view>
        <view class="share-modal-close" bindtap="closeShareModal">×</view>
      </view>
      
      <view class="share-options">
        <button 
          class="share-option share-friend-btn" 
          open-type="share"
          bindtap="prepareShareToFriend"
        >
          <view class="share-icon">💬</view>
          <view class="share-text">微信好友</view>
        </button>
        <view class="share-option" bindtap="shareToTimeline">
          <view class="share-icon">👥</view>
          <view class="share-text">朋友圈</view>
        </view>
      </view>
    </view>
  </view>

  <view class="disclaimer" wx:if="{{showResults}}">
    <text class="disclaimer-text">
      本小程序基于传统文化开发，所有测算结果仅供娱乐参考。
    </text>
  </view>
</view>
