<!--index.wxml-->
<view class="container">
  <!-- 简化的页面头部 -->
  <view class="page-header">
    <view class="page-title-container">
      <view class="page-title">八字运势测算 🔮</view>
      <view class="page-subtitle">预测未来 · 指导人生</view>
    </view>
    <view class="page-decoration">⚊⚋</view>
  </view>

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 每日运势卡片 -->
    <view class="daily-fortune-card" wx:if="{{showDailyFortune}}">
      <view class="fortune-header">
        <view class="fortune-title">🌟 今日运势</view>
        <view class="fortune-date">{{todayDate}}</view>
        <view class="fortune-update" wx:if="{{lastFortuneUpdate}}">
          <text class="update-time">更新时间: {{lastFortuneUpdate}}</text>
        </view>
        <view class="offline-indicator" wx:if="{{familyOverview.isOfflineMode}}">
          <text class="offline-text">📱 离线模式</text>
        </view>
      </view>
      
      <!-- 加载状态 -->
      <view class="fortune-loading" wx:if="{{fortuneLoading}}">
        <text class="loading-text">🔄 正在计算运势...</text>
      </view>
      
      <!-- 家庭运势概览 -->
      <view class="family-overview" wx:if="{{familyOverview && familyOverview.totalMembers > 0 && !fortuneLoading}}">
        <view class="family-header">
          <text class="family-title">👨‍👩‍👧‍👦 家庭运势概览</text>
          <view class="family-stats">
            <text class="stat-item">{{familyOverview.totalMembers}}人</text>
            <text class="stat-separator">|</text>
            <text class="stat-item">平均{{familyOverview.averageScore}}分</text>
          </view>
        </view>
        
        <view class="family-score-display">
          <view class="score-circle">
            <text class="score-number">{{familyOverview.averageScore}}</text>
            <text class="score-label">家庭运势</text>
          </view>
          <view class="family-details">
            <text class="family-lucky">🍀 家庭幸运色: {{familyOverview.familyLuckyColor}}</text>
            <text class="active-members">📈 活跃成员: {{familyOverview.activeMembers}}人</text>
          </view>
        </view>
        
        <view class="family-suggestions" wx:if="{{familyOverview.suggestions.length > 0}}">
          <text class="suggestion-item" wx:for="{{familyOverview.suggestions}}" wx:key="index">
            💡 {{item}}
          </text>
        </view>
      </view>
      
      <!-- 通用运势（无家庭成员时显示） -->
      <view class="universal-fortune" wx:if="{{universalFortune && familyOverview.totalMembers === 0 && !fortuneLoading}}">
        <view class="fortune-section">
          <view class="fortune-score">
            <text class="score-label">通用运势</text>
            <view class="stars">
              <text class="star {{index < universalFortune.overall_score ? 'filled' : ''}}" 
                    wx:for="{{[1,2,3,4,5]}}" wx:key="index">★</text>
            </view>
          </view>
          <view class="fortune-details">
            <text class="detail-item">🍀 幸运色：{{universalFortune.lucky_color}}</text>
            <text class="detail-item">🔢 幸运数字：{{universalFortune.lucky_numbers[0] || 8}}</text>
          </view>
        </view>
      </view>
      
      <!-- 个人专属运势列表 -->
      <view class="personal-fortunes" wx:if="{{membersWithFortune.length > 0 && !fortuneLoading}}">
        <view class="fortune-section-title">
          <text class="section-title">👤 家庭成员运势</text>
          <text class="members-count">({{membersWithFortune.length}}人)</text>
        </view>
        
        <view class="balanced-fortune-card" wx:for="{{membersWithFortune}}" wx:key="id">
          <!-- 平衡型卡片头部 -->
          <view class="balanced-header">
            <view class="member-section">
              <view class="member-avatar">{{item.name.charAt(0)}}</view>
              <view class="member-info">
                <view class="member-name">{{item.name}}</view>
                <view class="member-age" wx:if="{{item.dayun}}">{{item.dayun.current_age}}岁 · 第{{item.dayun.dayun_period}}大运期</view>
              </view>
            </view>
            <view class="score-section">
              <view class="score-number">{{item.daily_fortune.overall_score || 0}}</view>
              <view class="score-stars">
                <text class="star {{index < Math.floor(item.daily_fortune.overall_score || 0) ? 'filled' : ''}}" 
                      wx:for="{{[1,2,3,4,5]}}" wx:key="index" wx:for-item="starIndex" wx:for-index="index">★</text>
              </view>
            </view>
          </view>

          <!-- 平衡型运势详情 -->
          <view class="balanced-details" wx:if="{{item.hasValidFortune}}">
            <!-- 评分卡片 -->
            <view class="scores-cards">
              <view class="score-card">
                <view class="score-icon">💰</view>
                <view class="score-label">财运</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.wealth || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">💼</view>
                <view class="score-label">事业</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.career || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">🏥</view>
                <view class="score-label">健康</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.health || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">❤️</view>
                <view class="score-label">感情</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.love || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">📚</view>
                <view class="score-label">学习</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.study || 0}}</view>
              </view>
            </view>

            <!-- 幸运信息卡片 -->
            <view class="lucky-section" wx:if="{{item.daily_fortune.lucky_elements}}">
              <view class="lucky-card">
                <text class="lucky-label">🍀 幸运色</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_color}}</text>
              </view>
              <view class="lucky-card">
                <text class="lucky-label">🔢 幸运数</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_number || item.daily_fortune.lucky_elements.lucky_numbers[0] || 8}}</text>
              </view>
              <view class="lucky-card">
                <text class="lucky-label">🧭 方位</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_direction || '东方'}}</text>
              </view>
            </view>

            <!-- 今日建议 -->
            <view class="suggestions-section" wx:if="{{item.daily_fortune.suggestions && item.daily_fortune.suggestions.length > 0}}">
              <view class="section-title">💡 今日宜</view>
              <view class="suggestions-list">
                <text class="suggestion-tag" wx:for="{{item.daily_fortune.suggestions}}" wx:key="index" wx:if="{{index < 4}}">{{item}}</text>
              </view>
            </view>
          </view>

          <!-- 操作按钮 -->
          <view class="balanced-actions">
            <button class="action-btn primary" bindtap="handleViewDetail" data-index="{{index}}">
              <text class="btn-icon">📊</text>
              <text class="btn-text">详情</text>
            </button>
            <button class="action-btn secondary" bindtap="handleEditNote" data-member-id="{{item.id}}" data-member-name="{{item.name}}">
              <text class="btn-icon">📝</text>
              <text class="btn-text">备注</text>
            </button>
            <button class="action-btn danger" bindtap="handleDeleteMember" data-member-id="{{item.id}}" data-member-name="{{item.name}}">
              <text class="btn-icon">🗑️</text>
              <text class="btn-text">删除</text>
            </button>
          </view>

          <!-- 错误状态 -->
          <view class="error-state" wx:if="{{!item.hasValidFortune}}">
            <text class="error-icon">⚠️</text>
            <text class="error-text">运势计算失败，请稍后重试</text>
          </view>
        </view>
      </view>
      
      <!-- 提示信息 -->
      <view class="fortune-hint" wx:if="{{familyOverview.totalMembers === 0 && !fortuneLoading}}">
        <view class="hint-content">
          <text class="hint-text">💡 测算八字后获取专属运势</text>
          <text class="hint-desc">加入家庭成员，获得完整的家庭运势分析</text>
        </view>
      </view>
      
      
      <!-- 管理按钮 -->
      <view class="fortune-actions">
        <button class="action-btn primary" bindtap="refreshFortune" disabled="{{fortuneLoading}}">
          {{fortuneLoading ? '计算中...' : '刷新运势'}}
        </button>
      </view>
      
    </view>

    <view class="card">
    <view class="subtitle">请输入您的出生信息</view>
    
    <!-- 日历类型选择 -->
    <view class="input-group">
      <label class="input-label">日期类型</label>
      <radio-group bindchange="onCalendarTypeChange">
        <label class="radio-item">
          <radio value="solar" checked="{{calendarType === 'solar'}}" color="#40E0D0"/>
          公历
        </label>
        <label class="radio-item">
          <radio value="lunar" checked="{{calendarType === 'lunar'}}" color="#40E0D0"/>
          农历
        </label>
      </radio-group>
    </view>

    <!-- 出生日期选择 -->
    <view class="input-group">
      <label class="input-label">出生日期</label>
      
      <!-- 公历日期选择器 -->
      <view wx:if="{{calendarType === 'solar'}}" class="date-picker-container">
        <picker mode="date" value="{{birthDate}}" start="1900-01-01" end="{{maxDate}}" bindchange="onDateChange">
          <view class="picker">
            {{birthDate || '请选择公历出生日期'}}
          </view>
        </picker>
        <view class="date-type-hint">
          选择公历日期（如：1990-01-15）
          <view wx:if="{{birthDate && correspondingLunarDate}}" class="corresponding-date">
            对应农历：{{correspondingLunarDate}}
          </view>
        </view>
      </view>
      
      <!-- 农历日期选择器 -->
      <view wx:if="{{calendarType === 'lunar'}}" class="lunar-picker-container">
        <view class="lunar-pickers">
          <!-- 农历年选择器 -->
          <picker class="lunar-year-picker" value="{{lunarYearIndex}}" range="{{lunarYears}}" bindchange="onLunarYearChange">
            <view class="picker">
              {{lunarYear ? lunarYear + '年' : '年'}}
            </view>
          </picker>
          
          <!-- 农历月选择器 -->
          <picker class="lunar-month-picker" value="{{lunarMonthIndex}}" range="{{lunarMonths}}" bindchange="onLunarMonthChange">
            <view class="picker">
              {{lunarMonth || '月'}}
            </view>
          </picker>
          
          <!-- 农历日选择器 -->
          <picker class="lunar-day-picker" value="{{lunarDayIndex}}" range="{{lunarDays}}" bindchange="onLunarDayChange">
            <view class="picker">
              {{lunarDay || '日'}}
            </view>
          </picker>
        </view>
        
        <view class="date-type-hint">
          选择农历日期
          <view wx:if="{{lunarYear && lunarMonth && lunarDay && correspondingSolarDate}}" class="corresponding-date">
            对应公历：{{correspondingSolarDate}}
          </view>
        </view>
      </view>
    </view>

    <!-- 出生时间选择 -->
    <view class="input-group">
      <label class="input-label">出生时间</label>
      <picker mode="time" value="{{birthTime}}" bindchange="onTimeChange">
        <view class="picker">
          {{birthTime || '请选择出生时间'}}
        </view>
      </picker>
    </view>

    <!-- 性别选择 -->
    <view class="input-group">
      <label class="input-label">性别</label>
      <radio-group bindchange="onGenderChange">
        <label class="radio-item">
          <radio value="male" checked="{{gender === 'male'}}" color="#40E0D0"/>
          男
        </label>
        <label class="radio-item">
          <radio value="female" checked="{{gender === 'female'}}" color="#40E0D0"/>
          女
        </label>
      </radio-group>
    </view>

    <!-- 激励视频广告 - 已隐藏（微信广告系统自己集成） -->

    <!-- 测算按钮 -->
    <button class="btn-primary" 
            bindtap="calculateBazi" 
            disabled="{{!canCalculate}}"
            loading="{{calculating}}">
      {{calculating ? '正在测算中...' : '开始测算'}}
    </button>
  </view>


    <!-- 免责声明 -->
    <view class="disclaimer">
      本小程序基于传统文化开发，所有测算结果仅供娱乐参考。
    </view>
  </view>
</view>
