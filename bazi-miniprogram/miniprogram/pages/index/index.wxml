<!--index.wxml-->
<view class="container">
  <!-- ç®€åŒ–çš„é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="page-title-container">
      <view class="page-title">å…«å­—è¿åŠ¿æµ‹ç®— ğŸ”®</view>
      <view class="page-subtitle">é¢„æµ‹æœªæ¥ Â· æŒ‡å¯¼äººç”Ÿ</view>
    </view>
    <view class="page-decoration">âšŠâš‹</view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- æ¯æ—¥è¿åŠ¿å¡ç‰‡ -->
    <view class="daily-fortune-card" wx:if="{{showDailyFortune}}">
      <view class="fortune-header">
        <view class="fortune-title">ğŸŒŸ ä»Šæ—¥è¿åŠ¿</view>
        <view class="fortune-date">{{todayDate}}</view>
        <view class="fortune-update" wx:if="{{lastFortuneUpdate}}">
          <text class="update-time">æ›´æ–°æ—¶é—´: {{lastFortuneUpdate}}</text>
        </view>
        <view class="offline-indicator" wx:if="{{familyOverview.isOfflineMode}}">
          <text class="offline-text">ğŸ“± ç¦»çº¿æ¨¡å¼</text>
        </view>
      </view>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="fortune-loading" wx:if="{{fortuneLoading}}">
        <text class="loading-text">ğŸ”„ æ­£åœ¨è®¡ç®—è¿åŠ¿...</text>
      </view>
      
      <!-- å®¶åº­è¿åŠ¿æ¦‚è§ˆ -->
      <view class="family-overview" wx:if="{{familyOverview && familyOverview.totalMembers > 0 && !fortuneLoading}}">
        <view class="family-header">
          <text class="family-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è¿åŠ¿æ¦‚è§ˆ</text>
          <view class="family-stats">
            <text class="stat-item">{{familyOverview.totalMembers}}äºº</text>
            <text class="stat-separator">|</text>
            <text class="stat-item">å¹³å‡{{familyOverview.averageScore}}åˆ†</text>
          </view>
        </view>
        
        <view class="family-score-display">
          <view class="score-circle">
            <text class="score-number">{{familyOverview.averageScore}}</text>
            <text class="score-label">å®¶åº­è¿åŠ¿</text>
          </view>
          <view class="family-details">
            <text class="family-lucky">ğŸ€ å®¶åº­å¹¸è¿è‰²: {{familyOverview.familyLuckyColor}}</text>
            <text class="active-members">ğŸ“ˆ æ´»è·ƒæˆå‘˜: {{familyOverview.activeMembers}}äºº</text>
          </view>
        </view>
        
        <view class="family-suggestions" wx:if="{{familyOverview.suggestions.length > 0}}">
          <text class="suggestion-item" wx:for="{{familyOverview.suggestions}}" wx:key="index">
            ğŸ’¡ {{item}}
          </text>
        </view>
      </view>
      
      <!-- é€šç”¨è¿åŠ¿ï¼ˆæ— å®¶åº­æˆå‘˜æ—¶æ˜¾ç¤ºï¼‰ -->
      <view class="universal-fortune" wx:if="{{universalFortune && familyOverview.totalMembers === 0 && !fortuneLoading}}">
        <view class="fortune-section">
          <view class="fortune-score">
            <text class="score-label">é€šç”¨è¿åŠ¿</text>
            <view class="stars">
              <text class="star {{index < universalFortune.overall_score ? 'filled' : ''}}" 
                    wx:for="{{[1,2,3,4,5]}}" wx:key="index">â˜…</text>
            </view>
          </view>
          <view class="fortune-details">
            <text class="detail-item">ğŸ€ å¹¸è¿è‰²ï¼š{{universalFortune.lucky_color}}</text>
            <text class="detail-item">ğŸ”¢ å¹¸è¿æ•°å­—ï¼š{{universalFortune.lucky_numbers[0] || 8}}</text>
          </view>
        </view>
      </view>
      
      <!-- ä¸ªäººä¸“å±è¿åŠ¿åˆ—è¡¨ -->
      <view class="personal-fortunes" wx:if="{{membersWithFortune.length > 0 && !fortuneLoading}}">
        <view class="fortune-section-title">
          <text class="section-title">ğŸ‘¤ å®¶åº­æˆå‘˜è¿åŠ¿</text>
          <text class="members-count">({{membersWithFortune.length}}äºº)</text>
        </view>
        
        <view class="balanced-fortune-card" wx:for="{{membersWithFortune}}" wx:key="id">
          <!-- å¹³è¡¡å‹å¡ç‰‡å¤´éƒ¨ -->
          <view class="balanced-header">
            <view class="member-section">
              <view class="member-avatar">{{item.name.charAt(0)}}</view>
              <view class="member-info">
                <view class="member-name">{{item.name}}</view>
                <view class="member-age" wx:if="{{item.dayun}}">{{item.dayun.current_age}}å² Â· ç¬¬{{item.dayun.dayun_period}}å¤§è¿æœŸ</view>
              </view>
            </view>
            <view class="score-section">
              <view class="score-number">{{item.daily_fortune.overall_score || 0}}</view>
              <view class="score-stars">
                <text class="star {{index < Math.floor(item.daily_fortune.overall_score || 0) ? 'filled' : ''}}" 
                      wx:for="{{[1,2,3,4,5]}}" wx:key="index" wx:for-item="starIndex" wx:for-index="index">â˜…</text>
              </view>
            </view>
          </view>

          <!-- å¹³è¡¡å‹è¿åŠ¿è¯¦æƒ… -->
          <view class="balanced-details" wx:if="{{item.hasValidFortune}}">
            <!-- è¯„åˆ†å¡ç‰‡ -->
            <view class="scores-cards">
              <view class="score-card">
                <view class="score-icon">ğŸ’°</view>
                <view class="score-label">è´¢è¿</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.wealth || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">ğŸ’¼</view>
                <view class="score-label">äº‹ä¸š</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.career || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">ğŸ¥</view>
                <view class="score-label">å¥åº·</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.health || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">â¤ï¸</view>
                <view class="score-label">æ„Ÿæƒ…</view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.love || 0}}</view>
              </view>
              <view class="score-card">
                <view class="score-icon">ğŸ“š</view>
                <view class="score-label">å­¦ä¹ </view>
                <view class="score-value">{{item.daily_fortune.detailed_scores.study || 0}}</view>
              </view>
            </view>

            <!-- å¹¸è¿ä¿¡æ¯å¡ç‰‡ -->
            <view class="lucky-section" wx:if="{{item.daily_fortune.lucky_elements}}">
              <view class="lucky-card">
                <text class="lucky-label">ğŸ€ å¹¸è¿è‰²</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_color}}</text>
              </view>
              <view class="lucky-card">
                <text class="lucky-label">ğŸ”¢ å¹¸è¿æ•°</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_number || item.daily_fortune.lucky_elements.lucky_numbers[0] || 8}}</text>
              </view>
              <view class="lucky-card">
                <text class="lucky-label">ğŸ§­ æ–¹ä½</text>
                <text class="lucky-value">{{item.daily_fortune.lucky_elements.lucky_direction || 'ä¸œæ–¹'}}</text>
              </view>
            </view>

            <!-- ä»Šæ—¥å»ºè®® -->
            <view class="suggestions-section" wx:if="{{item.daily_fortune.suggestions && item.daily_fortune.suggestions.length > 0}}">
              <view class="section-title">ğŸ’¡ ä»Šæ—¥å®œ</view>
              <view class="suggestions-list">
                <text class="suggestion-tag" wx:for="{{item.daily_fortune.suggestions}}" wx:key="index" wx:if="{{index < 4}}">{{item}}</text>
              </view>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="balanced-actions">
            <button class="action-btn primary" bindtap="handleViewDetail" data-index="{{index}}">
              <text class="btn-icon">ğŸ“Š</text>
              <text class="btn-text">è¯¦æƒ…</text>
            </button>
            <button class="action-btn secondary" bindtap="handleEditNote" data-member-id="{{item.id}}" data-member-name="{{item.name}}">
              <text class="btn-icon">ğŸ“</text>
              <text class="btn-text">å¤‡æ³¨</text>
            </button>
            <button class="action-btn danger" bindtap="handleDeleteMember" data-member-id="{{item.id}}" data-member-name="{{item.name}}">
              <text class="btn-icon">ğŸ—‘ï¸</text>
              <text class="btn-text">åˆ é™¤</text>
            </button>
          </view>

          <!-- é”™è¯¯çŠ¶æ€ -->
          <view class="error-state" wx:if="{{!item.hasValidFortune}}">
            <text class="error-icon">âš ï¸</text>
            <text class="error-text">è¿åŠ¿è®¡ç®—å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</text>
          </view>
        </view>
      </view>
      
      <!-- æç¤ºä¿¡æ¯ -->
      <view class="fortune-hint" wx:if="{{familyOverview.totalMembers === 0 && !fortuneLoading}}">
        <view class="hint-content">
          <text class="hint-text">ğŸ’¡ æµ‹ç®—å…«å­—åè·å–ä¸“å±è¿åŠ¿</text>
          <text class="hint-desc">åŠ å…¥å®¶åº­æˆå‘˜ï¼Œè·å¾—å®Œæ•´çš„å®¶åº­è¿åŠ¿åˆ†æ</text>
        </view>
      </view>
      
      
      <!-- ç®¡ç†æŒ‰é’® -->
      <view class="fortune-actions">
        <button class="action-btn primary" bindtap="refreshFortune" disabled="{{fortuneLoading}}">
          {{fortuneLoading ? 'è®¡ç®—ä¸­...' : 'åˆ·æ–°è¿åŠ¿'}}
        </button>
      </view>
      
    </view>

    <view class="card">
    <view class="subtitle">è¯·è¾“å…¥æ‚¨çš„å‡ºç”Ÿä¿¡æ¯</view>
    
    <!-- æ—¥å†ç±»å‹é€‰æ‹© -->
    <view class="input-group">
      <label class="input-label">æ—¥æœŸç±»å‹</label>
      <radio-group bindchange="onCalendarTypeChange">
        <label class="radio-item">
          <radio value="solar" checked="{{calendarType === 'solar'}}" color="#40E0D0"/>
          å…¬å†
        </label>
        <label class="radio-item">
          <radio value="lunar" checked="{{calendarType === 'lunar'}}" color="#40E0D0"/>
          å†œå†
        </label>
      </radio-group>
    </view>

    <!-- å‡ºç”Ÿæ—¥æœŸé€‰æ‹© -->
    <view class="input-group">
      <label class="input-label">å‡ºç”Ÿæ—¥æœŸ</label>
      
      <!-- å…¬å†æ—¥æœŸé€‰æ‹©å™¨ -->
      <view wx:if="{{calendarType === 'solar'}}" class="date-picker-container">
        <picker mode="date" value="{{birthDate}}" start="1900-01-01" end="{{maxDate}}" bindchange="onDateChange">
          <view class="picker">
            {{birthDate || 'è¯·é€‰æ‹©å…¬å†å‡ºç”Ÿæ—¥æœŸ'}}
          </view>
        </picker>
        <view class="date-type-hint">
          é€‰æ‹©å…¬å†æ—¥æœŸï¼ˆå¦‚ï¼š1990-01-15ï¼‰
          <view wx:if="{{birthDate && correspondingLunarDate}}" class="corresponding-date">
            å¯¹åº”å†œå†ï¼š{{correspondingLunarDate}}
          </view>
        </view>
      </view>
      
      <!-- å†œå†æ—¥æœŸé€‰æ‹©å™¨ -->
      <view wx:if="{{calendarType === 'lunar'}}" class="lunar-picker-container">
        <view class="lunar-pickers">
          <!-- å†œå†å¹´é€‰æ‹©å™¨ -->
          <picker class="lunar-year-picker" value="{{lunarYearIndex}}" range="{{lunarYears}}" bindchange="onLunarYearChange">
            <view class="picker">
              {{lunarYear ? lunarYear + 'å¹´' : 'å¹´'}}
            </view>
          </picker>
          
          <!-- å†œå†æœˆé€‰æ‹©å™¨ -->
          <picker class="lunar-month-picker" value="{{lunarMonthIndex}}" range="{{lunarMonths}}" bindchange="onLunarMonthChange">
            <view class="picker">
              {{lunarMonth || 'æœˆ'}}
            </view>
          </picker>
          
          <!-- å†œå†æ—¥é€‰æ‹©å™¨ -->
          <picker class="lunar-day-picker" value="{{lunarDayIndex}}" range="{{lunarDays}}" bindchange="onLunarDayChange">
            <view class="picker">
              {{lunarDay || 'æ—¥'}}
            </view>
          </picker>
        </view>
        
        <view class="date-type-hint">
          é€‰æ‹©å†œå†æ—¥æœŸ
          <view wx:if="{{lunarYear && lunarMonth && lunarDay && correspondingSolarDate}}" class="corresponding-date">
            å¯¹åº”å…¬å†ï¼š{{correspondingSolarDate}}
          </view>
        </view>
      </view>
    </view>

    <!-- å‡ºç”Ÿæ—¶é—´é€‰æ‹© -->
    <view class="input-group">
      <label class="input-label">å‡ºç”Ÿæ—¶é—´</label>
      <picker mode="time" value="{{birthTime}}" bindchange="onTimeChange">
        <view class="picker">
          {{birthTime || 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¶é—´'}}
        </view>
      </picker>
    </view>

    <!-- æ€§åˆ«é€‰æ‹© -->
    <view class="input-group">
      <label class="input-label">æ€§åˆ«</label>
      <radio-group bindchange="onGenderChange">
        <label class="radio-item">
          <radio value="male" checked="{{gender === 'male'}}" color="#40E0D0"/>
          ç”·
        </label>
        <label class="radio-item">
          <radio value="female" checked="{{gender === 'female'}}" color="#40E0D0"/>
          å¥³
        </label>
      </radio-group>
    </view>

    <!-- æ¿€åŠ±è§†é¢‘å¹¿å‘Š - å·²éšè—ï¼ˆå¾®ä¿¡å¹¿å‘Šç³»ç»Ÿè‡ªå·±é›†æˆï¼‰ -->

    <!-- æµ‹ç®—æŒ‰é’® -->
    <button class="btn-primary" 
            bindtap="calculateBazi" 
            disabled="{{!canCalculate}}"
            loading="{{calculating}}">
      {{calculating ? 'æ­£åœ¨æµ‹ç®—ä¸­...' : 'å¼€å§‹æµ‹ç®—'}}
    </button>
  </view>


    <!-- å…è´£å£°æ˜ -->
    <view class="disclaimer">
      æœ¬å°ç¨‹åºåŸºäºä¼ ç»Ÿæ–‡åŒ–å¼€å‘ï¼Œæ‰€æœ‰æµ‹ç®—ç»“æœä»…ä¾›å¨±ä¹å‚è€ƒã€‚
    </view>
  </view>
</view>
