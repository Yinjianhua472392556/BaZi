# 🔄 服务器重新部署指南

## 📋 概述

由于您的服务器已经在运行，需要先暂停现有服务，然后拉取最新代码进行重新部署。

## ⚠️ 重要提醒

最新的 `auto_deploy.sh` 已经完全优化，解决了所有HTTPS问题：
- ✅ 移除日志文件错误
- ✅ 消除交互式卡住
- ✅ 整合完整HTTPS修复
- ✅ 完全自动化部署

## 🚀 完整重新部署步骤

### 第一步：连接服务器

```bash
# 使用SSH连接到您的腾讯云服务器
ssh root@119.91.146.128

# 或者直接在腾讯云控制台的终端中操作
```

### 第二步：停止现有服务

```bash
# 停止API服务
systemctl stop bazi-api

# 停止Nginx服务
systemctl stop nginx

# 确认服务已停止
systemctl status bazi-api nginx
```

### 第三步：备份现有配置（可选）

```bash
# 备份当前部署
cp -r /opt/bazi-app /opt/bazi-app.backup.$(date +%Y%m%d_%H%M%S)

# 备份Nginx配置
cp /etc/nginx/sites-available/bazi-api /etc/nginx/sites-available/bazi-api.backup.$(date +%Y%m%d_%H%M%S)
```

### 第四步：拉取最新代码

```bash
# 进入项目目录
cd /opt/bazi-app/bazi-miniprogram

# 拉取最新代码
git pull origin main

# 确认代码更新成功
git log --oneline -5
```

### 第五步：执行一键重新部署

```bash
# 进入部署目录
cd /opt/bazi-app/bazi-miniprogram/deployment

# 执行优化后的一键部署脚本
sudo bash auto_deploy.sh
```

## 🎯 部署过程说明

### 自动化流程
脚本会自动执行以下步骤：

1. **检查部署前置条件** - 验证配置和环境
2. **更新系统并安装基础依赖** - 确保环境完整
3. **创建应用用户和目录** - 设置运行环境
4. **克隆项目代码** - 获取最新代码（会自动备份旧版本）
5. **配置Python环境** - 更新依赖包
6. **配置生产环境** - 设置权限和配置
7. **创建系统服务** - 更新systemd服务
8. **配置Nginx反向代理** - 基础HTTP配置
9. **配置SSL证书和HTTPS** - **重点：完整HTTPS修复**
10. **启动应用服务** - 启动所有服务
11. **验证部署结果** - 测试功能完整性

### HTTPS修复特性
第9步会自动解决您遇到的HTTPS问题：
- 自动停止服务释放80/443端口
- 清理损坏的证书文件
- 重新申请SSL证书
- 修复证书权限问题
- 创建完整的HTTPS Nginx配置
- 验证HTTPS访问功能

## ✅ 验证部署成功

### 1. 检查服务状态
```bash
# 检查服务运行状态
systemctl status bazi-api nginx

# 查看端口监听
netstat -tlnp | grep -E "(80|443|8001)"
```

### 2. 测试HTTP和HTTPS访问
```bash
# 测试HTTP访问（应该重定向到HTTPS）
curl -I http://api.bazi365.top/health

# 测试HTTPS访问（应该返回200）
curl -I https://api.bazi365.top/health
```

### 3. 运行完整API测试
```bash
# 在部署目录执行完整测试
cd /opt/bazi-app/bazi-miniprogram/deployment
bash test_all_apis.sh
```

## 🔧 常见问题处理

### 问题1：部署过程中有警告或错误
```bash
# 查看服务日志
journalctl -u bazi-api -f

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log
```

### 问题2：HTTPS仍然无法访问
```bash
# 检查SSL证书状态
certbot certificates

# 测试Nginx配置
nginx -t

# 重启服务
systemctl restart nginx bazi-api
```

### 问题3：API功能异常
```bash
# 检查Python环境
cd /opt/bazi-app/bazi-miniprogram
source venv/bin/activate
python -c "import fastapi; print('FastAPI OK')"

# 手动启动测试
python main.py
```

## 📊 预期结果

部署成功后，您应该看到：

### 控制台输出：
```
═══════════════════════════════════════════════════════════════
                    🎉 部署完成！
═══════════════════════════════════════════════════════════════

🎯 部署成功完成！
📋 快速测试:
   curl https://api.bazi365.top/health
```

### HTTPS访问测试：
```bash
$ curl -I https://api.bazi365.top/health
HTTP/2 200
server: nginx/1.18.0
date: Thu, 10 Oct 2025 10:00:00 GMT
content-type: application/json
content-length: 25
```

### API测试结果：
- ✅ 所有核心接口测试通过
- ✅ HTTPS安全访问正常
- ✅ SSL证书配置正确

## 🚨 紧急恢复（如果新部署失败）

如果新部署出现问题，可以快速恢复：

```bash
# 停止新服务
systemctl stop bazi-api nginx

# 恢复备份
rm -rf /opt/bazi-app
mv /opt/bazi-app.backup.* /opt/bazi-app

# 恢复Nginx配置
cp /etc/nginx/sites-available/bazi-api.backup.* /etc/nginx/sites-available/bazi-api

# 启动恢复的服务
systemctl start bazi-api nginx
```

## 📞 支持信息

### 如果遇到问题，请提供：
1. **部署过程的完整控制台输出**
2. **服务状态信息**：`systemctl status bazi-api nginx`
3. **错误日志内容**：`journalctl -u bazi-api --no-pager -n 50`
4. **Nginx错误日志**：`tail -50 /var/log/nginx/error.log`

### 快速联系方式：
- 提供完整的错误信息和日志
- 说明具体的失败步骤
- 包含服务器环境信息

---

## 🎉 总结

新的部署脚本已经完全解决了您之前遇到的所有问题：

✅ **无日志文件错误** - 改为纯控制台输出  
✅ **无交互式卡住** - 完全自动化流程  
✅ **HTTPS完整修复** - 自动解决SSL配置问题  
✅ **智能错误处理** - 自动诊断和恢复  

现在您只需要执行上述步骤，就能获得一个完全正常工作的HTTPS服务！
