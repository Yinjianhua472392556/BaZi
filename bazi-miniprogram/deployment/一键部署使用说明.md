# 🚀 八字运势小程序 - 一键部署使用说明

## 📋 概述

已对 `auto_deploy.sh` 进行优化，现在支持完全自动化的一键部署，包含完整的HTTPS配置和修复功能。

## ✨ 优化特性

### 🎯 主要改进
- ✅ **完全自动化** - 移除所有交互式询问
- ✅ **无日志文件** - 节省服务器资源，只使用控制台输出
- ✅ **HTTPS完整修复** - 整合了 `fix_https.sh` 的所有修复逻辑
- ✅ **智能错误处理** - 自动诊断和修复常见问题
- ✅ **资源优化** - 最小化磁盘和内存使用

### 🔧 技术特性
- **SSL证书完整配置** - 自动申请、权限修复、配置验证
- **Nginx HTTPS配置** - 包含安全头、HTTP重定向、SSL优化
- **服务自动重启** - 智能处理服务启动和配置更新
- **错误容忍性** - 单步失败不影响整体部署流程

## 🚀 快速使用

### 1. 服务器端操作

```bash
# 1. 拉取最新代码
cd /opt/bazi-app/bazi-miniprogram
git pull origin main

# 2. 进入部署目录
cd deployment

# 3. 一键部署（完全自动化）
sudo bash auto_deploy.sh
```

### 2. 部署过程

脚本会自动执行以下10个步骤：

1. **检查部署前置条件** - 验证配置和环境
2. **更新系统并安装基础依赖** - 安装必要软件
3. **创建应用用户和目录** - 设置运行环境
4. **克隆项目代码** - 获取最新代码
5. **配置Python环境** - 安装依赖和虚拟环境
6. **配置生产环境** - 设置权限和配置
7. **创建系统服务** - 创建systemd服务
8. **配置Nginx反向代理** - 基础HTTP配置
9. **配置SSL证书和HTTPS** - 完整HTTPS配置
10. **启动应用服务** - 启动所有服务
11. **验证部署结果** - 测试功能完整性

## 🔒 HTTPS配置详情

### 自动修复功能
脚本在第9步会自动执行以下HTTPS修复：

1. **停止冲突服务** - 释放80/443端口
2. **清理问题证书** - 删除损坏的证书文件
3. **重新申请证书** - 使用Let's Encrypt申请新证书
4. **修复证书权限** - 确保Nginx可读取证书
5. **创建HTTPS配置** - 生成完整的Nginx HTTPS配置
6. **验证HTTPS访问** - 测试HTTPS连接

### 安全特性
- **强制HTTPS重定向** - HTTP自动跳转到HTTPS
- **现代SSL协议** - 支持TLSv1.2和TLSv1.3
- **安全头配置** - HSTS、XSS保护、内容类型保护
- **证书自动续期** - 设置cron任务自动续期

## 📊 部署验证

### 自动验证项目
- ✅ API服务状态检查
- ✅ Nginx服务状态检查  
- ✅ 端口监听验证
- ✅ 本地API访问测试
- ✅ HTTPS域名访问测试

### 手动验证命令
```bash
# 测试HTTPS访问
curl -I https://api.bazi365.top/health

# 查看服务状态
systemctl status bazi-api nginx

# 查看端口监听
netstat -tlnp | grep -E "(80|443|8001)"

# 运行完整API测试
cd /opt/bazi-app/bazi-miniprogram/deployment
bash test_all_apis.sh
```

## 🛠 故障排除

### 常见问题处理

#### 1. 证书申请失败
```bash
# 检查域名解析
nslookup api.bazi365.top

# 检查防火墙
ufw status

# 手动重新申请
certbot certonly --standalone -d api.bazi365.top
```

#### 2. Nginx配置错误
```bash
# 测试配置语法
nginx -t

# 查看错误日志
tail -f /var/log/nginx/error.log

# 重新加载配置
systemctl reload nginx
```

#### 3. API服务启动失败
```bash
# 查看服务状态
systemctl status bazi-api

# 查看详细日志
journalctl -u bazi-api -f

# 手动启动测试
cd /opt/bazi-app/bazi-miniprogram
source venv/bin/activate
python main.py
```

## 📱 小程序配置更新

部署完成后，请更新小程序中的API地址：

```javascript
// miniprogram/app.js
App({
  globalData: {
    apiBaseUrl: 'https://api.bazi365.top'
  }
})
```

## 🔧 服务管理

### 常用管理命令

```bash
# 重启API服务
systemctl restart bazi-api

# 重启Nginx
systemctl restart nginx

# 查看服务日志
journalctl -u bazi-api -f

# 查看Nginx访问日志
tail -f /var/log/nginx/api.bazi365.top_access.log

# 查看Nginx错误日志
tail -f /var/log/nginx/api.bazi365.top_error.log
```

### 证书管理

```bash
# 查看证书状态
certbot certificates

# 手动续期证书
certbot renew

# 测试续期
certbot renew --dry-run
```

## 💡 最佳实践

### 定期维护
1. **每月检查证书状态** - 确保自动续期正常
2. **监控服务状态** - 定期检查API和Nginx服务
3. **更新系统** - 定期更新系统和依赖包
4. **备份重要数据** - 定期备份配置和数据

### 性能优化
1. **监控资源使用** - 内存、CPU、磁盘使用情况
2. **日志轮转** - 设置Nginx日志自动清理
3. **缓存优化** - 静态文件缓存配置
4. **负载均衡** - 高并发时考虑负载均衡

## 📞 技术支持

如果遇到问题，请提供：
1. **部署控制台输出** - 完整的部署过程输出
2. **服务状态信息** - `systemctl status` 输出
3. **错误日志** - 相关的错误日志内容
4. **环境信息** - 系统版本、网络配置等

---

## 🎉 总结

优化后的部署脚本具有以下优势：

✅ **一键操作** - 只需一个命令完成所有部署  
✅ **完全自动化** - 无需人工干预或交互  
✅ **资源友好** - 最小化服务器资源使用  
✅ **HTTPS完整** - 包含完整的SSL配置和修复  
✅ **错误容忍** - 智能处理部署过程中的错误  
✅ **验证完整** - 自动验证部署结果和功能  

现在您只需要在服务器上运行 `git pull && sudo bash auto_deploy.sh` 即可完成完整的部署和HTTPS配置！
