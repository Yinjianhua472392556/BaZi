# 🚀 服务器重新部署详细步骤

## 📋 第一步：连接到服务器

使用SSH连接到您的腾讯云服务器：
```bash
ssh root@119.91.146.128
```

## 📋 第二步：停止现有服务

为了安全重新部署，先停止现有服务：
```bash
# 停止API服务和Nginx
systemctl stop bazi-api nginx

# 确认服务已停止
systemctl status bazi-api nginx
```

## 📋 第三步：定位并进入项目目录

```bash
# 查找项目位置
find /opt -name "bazi-miniprogram" 2>/dev/null

# 进入项目目录（根据实际路径调整）
cd /opt/bazi-app/bazi-miniprogram
```

如果找不到项目目录，使用重新克隆方案：
```bash
cd /opt
mkdir -p bazi-app && cd bazi-app
git clone https://github.com/Yinjianhua472392556/BaZi.git
cd BaZi/bazi-miniprogram
```

## 📋 第四步：拉取最新代码

```bash
# 拉取最新的修复代码
git pull origin main

# 确认拉取成功
git log --oneline -5
```

## 📋 第五步：进入部署目录

```bash
cd deployment

# 确认修复脚本存在
ls -la auto_deploy.sh fix_ssl_issues.sh
```

## 📋 第六步：执行重新部署

### 方案一：完整重新部署（推荐）
```bash
sudo bash auto_deploy.sh
```

这个脚本会：
- ✅ 自动检测环境
- ✅ 重新安装依赖
- ✅ 重新配置服务
- ✅ 智能修复SSL证书
- ✅ 启动所有服务

### 方案二：仅修复SSL问题
如果只是SSL问题，可以使用：
```bash
sudo bash fix_ssl_issues.sh
```

## 📋 第七步：验证部署结果

等待部署完成后，验证服务状态：

```bash
# 1. 检查服务状态
systemctl status bazi-api nginx

# 2. 检查端口监听
netstat -tlnp | grep -E ':(80|443|8001) '

# 3. 测试HTTP访问
curl -I http://api.bazi365.top/health

# 4. 测试HTTPS访问
curl -I https://api.bazi365.top/health

# 5. 检查SSL证书
ls -la /etc/letsencrypt/live/api.bazi365.top/
```

## 🎯 预期成功结果

部署成功后您应该看到：

1. **服务状态正常**：
   ```
   ● bazi-api.service - 八字运势小程序 API服务
      Active: active (running)
   
   ● nginx.service - A high performance web server
      Active: active (running)
   ```

2. **端口正常监听**：
   ```
   :80    LISTEN    nginx
   :443   LISTEN    nginx  
   :8001  LISTEN    python
   ```

3. **HTTP和HTTPS访问都正常**：
   ```
   HTTP/1.1 200 OK        # HTTP访问
   HTTP/2 200             # HTTPS访问
   ```

## 🆘 如果部署失败

### 查看错误日志：
```bash
# 查看API服务日志
journalctl -u bazi-api -f

# 查看Nginx日志
tail -f /var/log/nginx/error.log

# 测试Nginx配置
nginx -t
```

### 重新尝试：
```bash
# 如果部署失败，可以重新运行
sudo bash auto_deploy.sh
```

### 紧急恢复HTTP服务：
如果HTTPS有问题但需要先恢复HTTP服务：
```bash
# 创建简单HTTP配置
cat > /etc/nginx/sites-available/bazi-api << 'EOF'
server {
    listen 80;
    server_name api.bazi365.top;
    
    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

# 启用配置并重启
nginx -t && systemctl restart nginx
systemctl start bazi-api
```

## 📞 完成标志

当您看到以下输出时，表示部署完全成功：

```
✅ SSL证书和HTTPS配置完成
✅ 所有服务启动完成
✅ 部署验证完成
🎉 部署完成！
```

现在您的八字运势小程序API服务已经完全恢复正常，HTTPS访问问题已解决！

---

**💡 提示**：如果遇到任何问题，所有的修复脚本都包含详细的错误处理和自动恢复机制，可以安全地重复运行。
