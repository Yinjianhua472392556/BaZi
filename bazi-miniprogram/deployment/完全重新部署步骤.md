# ğŸ—‘ï¸ å®Œå…¨æ¸…ç†å¹¶é‡æ–°éƒ¨ç½²æ­¥éª¤

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@119.91.146.128
```

## ğŸ“‹ ç¬¬äºŒæ­¥ï¼šå®Œå…¨åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡
systemctl stop bazi-api nginx

# ç¡®è®¤æœåŠ¡å·²åœæ­¢
systemctl status bazi-api nginx
```

## ğŸ“‹ ç¬¬ä¸‰æ­¥ï¼šå®Œå…¨åˆ é™¤æ—§çš„é¡¹ç›®ä»£ç 

```bash
# æŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰æ—§çš„é¡¹ç›®ç›®å½•
find / -name "bazi-miniprogram" -type d 2>/dev/null

# åˆ é™¤å¸¸è§çš„éƒ¨ç½²ä½ç½®ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
rm -rf /opt/bazi-app
rm -rf /opt/BaZi
rm -rf /root/bazi-miniprogram
rm -rf /home/*/bazi-miniprogram

# ç¡®è®¤åˆ é™¤å®Œæˆ
find / -name "bazi-miniprogram" -type d 2>/dev/null
```

## ğŸ“‹ ç¬¬å››æ­¥ï¼šæ¸…ç†ç³»ç»ŸæœåŠ¡æ–‡ä»¶

```bash
# åœç”¨å¹¶åˆ é™¤æ—§çš„systemdæœåŠ¡
systemctl stop bazi-api 2>/dev/null || true
systemctl disable bazi-api 2>/dev/null || true
rm -f /etc/systemd/system/bazi-api.service

# é‡æ–°åŠ è½½systemd
systemctl daemon-reload
```

## ğŸ“‹ ç¬¬äº”æ­¥ï¼šæ¸…ç†Nginxé…ç½®

```bash
# åˆ é™¤æ—§çš„Nginxé…ç½®
rm -f /etc/nginx/sites-available/bazi-api
rm -f /etc/nginx/sites-enabled/bazi-api

# åˆ é™¤æ—§çš„SSLè¯ä¹¦ï¼ˆå¦‚æœæœ‰é—®é¢˜çš„è¯ï¼‰
rm -rf /etc/letsencrypt/live/api.bazi365.top
rm -rf /etc/letsencrypt/archive/api.bazi365.top
rm -rf /etc/letsencrypt/renewal/api.bazi365.top.conf

# æµ‹è¯•Nginxé…ç½®
nginx -t
```

## ğŸ“‹ ç¬¬å…­æ­¥ï¼šé‡æ–°å…‹éš†æœ€æ–°ä»£ç 

```bash
# åˆ›å»ºæ–°çš„éƒ¨ç½²ç›®å½•
cd /opt
mkdir -p bazi-app && cd bazi-app

# å…‹éš†æœ€æ–°çš„ä»£ç ï¼ˆåŒ…å«æ‰€æœ‰ä¿®å¤ï¼‰
git clone https://github.com/Yinjianhua472392556/BaZi.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd BaZi/bazi-miniprogram

# ç¡®è®¤æ‹‰å–åˆ°æœ€æ–°ä»£ç 
git log --oneline -5
```

## ğŸ“‹ ç¬¬ä¸ƒæ­¥ï¼šæ£€æŸ¥ä¿®å¤åçš„è„šæœ¬

```bash
cd deployment

# ç¡®è®¤æ‰€æœ‰ä¿®å¤è„šæœ¬éƒ½å­˜åœ¨
ls -la auto_deploy.sh fix_ssl_issues.sh deploy_config.sh

# ç¡®è®¤è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x auto_deploy.sh fix_ssl_issues.sh
```

## ğŸ“‹ ç¬¬å…«æ­¥ï¼šæ‰§è¡Œå…¨æ–°éƒ¨ç½²

```bash
# ä½¿ç”¨ä¿®å¤åçš„ä¸€é”®éƒ¨ç½²è„šæœ¬
sudo bash auto_deploy.sh
```

è¿™ä¸ªä¿®å¤åçš„è„šæœ¬ä¼šï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–
- âœ… åˆ›å»ºæ–°çš„åº”ç”¨ç”¨æˆ·å’Œç›®å½•
- âœ… è®¾ç½®Pythonè™šæ‹Ÿç¯å¢ƒ
- âœ… åˆ›å»ºç³»ç»ŸæœåŠ¡
- âœ… é…ç½®Nginxåå‘ä»£ç†
- âœ… **æ™ºèƒ½SSLé…ç½®ï¼ˆä¸‰é˜¶æ®µï¼šHTTPâ†’è¯ä¹¦â†’HTTPSï¼‰**
- âœ… å¯åŠ¨å¹¶éªŒè¯æ‰€æœ‰æœåŠ¡

## ğŸ“‹ ç¬¬ä¹æ­¥ï¼šéªŒè¯éƒ¨ç½²ç»“æœ

```bash
# ç­‰å¾…éƒ¨ç½²å®Œæˆï¼Œç„¶åéªŒè¯
sleep 30

# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status bazi-api nginx

# 2. æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep -E ':(80|443|8001) '

# 3. æµ‹è¯•HTTPè®¿é—®
curl -I http://api.bazi365.top/health

# 4. æµ‹è¯•HTTPSè®¿é—®
curl -I https://api.bazi365.top/health

# 5. æ£€æŸ¥SSLè¯ä¹¦
ls -la /etc/letsencrypt/live/api.bazi365.top/

# 6. è¿è¡Œå®Œæ•´APIæµ‹è¯•
cd /opt/bazi-app/BaZi/bazi-miniprogram/deployment
bash test_all_apis.sh
```

## ğŸ¯ é¢„æœŸæˆåŠŸç»“æœ

å®Œå…¨é‡æ–°éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

1. **æœåŠ¡çŠ¶æ€æ­£å¸¸**ï¼š
   ```
   â— bazi-api.service - å…«å­—è¿åŠ¿å°ç¨‹åº APIæœåŠ¡
      Active: active (running)
   
   â— nginx.service - A high performance web server
      Active: active (running)
   ```

2. **ç«¯å£æ­£å¸¸ç›‘å¬**ï¼š
   ```
   :80    LISTEN    nginx
   :443   LISTEN    nginx  
   :8001  LISTEN    python
   ```

3. **HTTPå’ŒHTTPSè®¿é—®éƒ½æ­£å¸¸**ï¼š
   ```
   HTTP/1.1 200 OK        # HTTPè®¿é—®
   HTTP/2 200             # HTTPSè®¿é—®
   ```

4. **SSLè¯ä¹¦æ–‡ä»¶å­˜åœ¨**ï¼š
   ```
   /etc/letsencrypt/live/api.bazi365.top/fullchain.pem
   /etc/letsencrypt/live/api.bazi365.top/privkey.pem
   ```

## ğŸ”§ ä¿®å¤çš„å…³é”®æ”¹è¿›

è¿™æ¬¡çš„ä¿®å¤è„šæœ¬åŒ…å«äº†ä»¥ä¸‹å…³é”®æ”¹è¿›ï¼š

1. **ä¸‰é˜¶æ®µSSLé…ç½®**ï¼š
   - é˜¶æ®µ1ï¼šå¯åŠ¨HTTPæœåŠ¡
   - é˜¶æ®µ2ï¼šç”³è¯·SSLè¯ä¹¦
   - é˜¶æ®µ3ï¼šé…ç½®HTTPS

2. **å¤šé‡å¤‡é€‰æ–¹æ¡ˆ**ï¼š
   - webrootæ–¹å¼ï¼ˆé¦–é€‰ï¼‰
   - nginxæ’ä»¶æ–¹å¼
   - standaloneæ–¹å¼ï¼ˆå¤‡é€‰ï¼‰

3. **æ™ºèƒ½é™çº§æœºåˆ¶**ï¼š
   - SSLç”³è¯·å¤±è´¥æ—¶è‡ªåŠ¨ä¿æŒHTTPé…ç½®
   - ç¡®ä¿æœåŠ¡ä¸ä¼šä¸­æ–­

4. **å®Œæ•´æƒé™ä¿®å¤**ï¼š
   - è‡ªåŠ¨è®¾ç½®è¯ä¹¦æ–‡ä»¶æƒé™
   - ä¿®å¤ç›®å½•æ‰€æœ‰è€…

## ğŸ†˜ å¦‚æœä»æœ‰é—®é¢˜

å¦‚æœé‡æ–°éƒ¨ç½²åä»æœ‰é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**ï¼š
   ```bash
   journalctl -u bazi-api -f
   tail -f /var/log/nginx/error.log
   ```

2. **ä½¿ç”¨ä¸“ç”¨SSLä¿®å¤è„šæœ¬**ï¼š
   ```bash
   cd /opt/bazi-app/BaZi/bazi-miniprogram/deployment
   sudo bash fix_ssl_issues.sh
   ```

3. **é‡æ–°è¿è¡Œéƒ¨ç½²è„šæœ¬**ï¼š
   ```bash
   sudo bash auto_deploy.sh
   ```

## ğŸ“ å®Œæˆæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºæ—¶ï¼Œè¡¨ç¤ºå®Œå…¨é‡æ–°éƒ¨ç½²æˆåŠŸï¼š

```
âœ… SSLè¯ä¹¦å’ŒHTTPSé…ç½®å®Œæˆ
âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ
âœ… éƒ¨ç½²éªŒè¯å®Œæˆ
ğŸ‰ éƒ¨ç½²å®Œæˆï¼
```

ç°åœ¨æ‚¨çš„æœåŠ¡å·²ç»ä»é›¶å¼€å§‹é‡æ–°éƒ¨ç½²ï¼Œä½¿ç”¨æœ€æ–°çš„ä¿®å¤ä»£ç ï¼ŒHTTPSé—®é¢˜åº”è¯¥å®Œå…¨è§£å†³ï¼

---

**ğŸ’¡ é‡è¦æç¤º**ï¼šè¿™æ˜¯å®Œå…¨æ¸…ç†é‡å»ºçš„æ–¹æ¡ˆï¼Œä¼šåˆ é™¤æ‰€æœ‰æ—§æ–‡ä»¶å¹¶é‡æ–°å¼€å§‹ã€‚æ‰€æœ‰çš„SSLå’Œé…ç½®é—®é¢˜éƒ½ä¼šå¾—åˆ°å½»åº•è§£å†³ã€‚
