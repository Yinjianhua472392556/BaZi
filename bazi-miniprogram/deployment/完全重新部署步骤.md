# 🗑️ 完全清理并重新部署步骤

## 📋 第一步：连接到服务器

```bash
ssh root@119.91.146.128
```

## 📋 第二步：完全停止所有相关服务

```bash
# 停止所有相关服务
systemctl stop bazi-api nginx

# 确认服务已停止
systemctl status bazi-api nginx
```

## 📋 第三步：完全删除旧的项目代码

```bash
# 查找并删除所有旧的项目目录
find / -name "bazi-miniprogram" -type d 2>/dev/null

# 删除常见的部署位置（请根据实际情况调整）
rm -rf /opt/bazi-app
rm -rf /opt/BaZi
rm -rf /root/bazi-miniprogram
rm -rf /home/*/bazi-miniprogram

# 确认删除完成
find / -name "bazi-miniprogram" -type d 2>/dev/null
```

## 📋 第四步：清理系统服务文件

```bash
# 停用并删除旧的systemd服务
systemctl stop bazi-api 2>/dev/null || true
systemctl disable bazi-api 2>/dev/null || true
rm -f /etc/systemd/system/bazi-api.service

# 重新加载systemd
systemctl daemon-reload
```

## 📋 第五步：清理Nginx配置

```bash
# 删除旧的Nginx配置
rm -f /etc/nginx/sites-available/bazi-api
rm -f /etc/nginx/sites-enabled/bazi-api

# 删除旧的SSL证书（如果有问题的话）
rm -rf /etc/letsencrypt/live/api.bazi365.top
rm -rf /etc/letsencrypt/archive/api.bazi365.top
rm -rf /etc/letsencrypt/renewal/api.bazi365.top.conf

# 测试Nginx配置
nginx -t
```

## 📋 第六步：重新克隆最新代码

```bash
# 创建新的部署目录
cd /opt
mkdir -p bazi-app && cd bazi-app

# 克隆最新的代码（包含所有修复）
git clone https://github.com/Yinjianhua472392556/BaZi.git

# 进入项目目录
cd BaZi/bazi-miniprogram

# 确认拉取到最新代码
git log --oneline -5
```

## 📋 第七步：检查修复后的脚本

```bash
cd deployment

# 确认所有修复脚本都存在
ls -la auto_deploy.sh fix_ssl_issues.sh deploy_config.sh

# 确认脚本有执行权限
chmod +x auto_deploy.sh fix_ssl_issues.sh
```

## 📋 第八步：执行全新部署

```bash
# 使用修复后的一键部署脚本
sudo bash auto_deploy.sh
```

这个修复后的脚本会：
- ✅ 自动检测并安装所有依赖
- ✅ 创建新的应用用户和目录
- ✅ 设置Python虚拟环境
- ✅ 创建系统服务
- ✅ 配置Nginx反向代理
- ✅ **智能SSL配置（三阶段：HTTP→证书→HTTPS）**
- ✅ 启动并验证所有服务

## 📋 第九步：验证部署结果

```bash
# 等待部署完成，然后验证
sleep 30

# 1. 检查服务状态
systemctl status bazi-api nginx

# 2. 检查端口监听
netstat -tlnp | grep -E ':(80|443|8001) '

# 3. 测试HTTP访问
curl -I http://api.bazi365.top/health

# 4. 测试HTTPS访问
curl -I https://api.bazi365.top/health

# 5. 检查SSL证书
ls -la /etc/letsencrypt/live/api.bazi365.top/

# 6. 运行完整API测试
cd /opt/bazi-app/BaZi/bazi-miniprogram/deployment
bash test_all_apis.sh
```

## 🎯 预期成功结果

完全重新部署成功后，您应该看到：

1. **服务状态正常**：
   ```
   ● bazi-api.service - 八字运势小程序 API服务
      Active: active (running)
   
   ● nginx.service - A high performance web server
      Active: active (running)
   ```

2. **端口正常监听**：
   ```
   :80    LISTEN    nginx
   :443   LISTEN    nginx  
   :8001  LISTEN    python
   ```

3. **HTTP和HTTPS访问都正常**：
   ```
   HTTP/1.1 200 OK        # HTTP访问
   HTTP/2 200             # HTTPS访问
   ```

4. **SSL证书文件存在**：
   ```
   /etc/letsencrypt/live/api.bazi365.top/fullchain.pem
   /etc/letsencrypt/live/api.bazi365.top/privkey.pem
   ```

## 🔧 修复的关键改进

这次的修复脚本包含了以下关键改进：

1. **三阶段SSL配置**：
   - 阶段1：启动HTTP服务
   - 阶段2：申请SSL证书
   - 阶段3：配置HTTPS

2. **多重备选方案**：
   - webroot方式（首选）
   - nginx插件方式
   - standalone方式（备选）

3. **智能降级机制**：
   - SSL申请失败时自动保持HTTP配置
   - 确保服务不会中断

4. **完整权限修复**：
   - 自动设置证书文件权限
   - 修复目录所有者

## 🆘 如果仍有问题

如果重新部署后仍有问题，可以：

1. **查看详细日志**：
   ```bash
   journalctl -u bazi-api -f
   tail -f /var/log/nginx/error.log
   ```

2. **使用专用SSL修复脚本**：
   ```bash
   cd /opt/bazi-app/BaZi/bazi-miniprogram/deployment
   sudo bash fix_ssl_issues.sh
   ```

3. **重新运行部署脚本**：
   ```bash
   sudo bash auto_deploy.sh
   ```

## 📞 完成标志

当您看到以下输出时，表示完全重新部署成功：

```
✅ SSL证书和HTTPS配置完成
✅ 所有服务启动完成
✅ 部署验证完成
🎉 部署完成！
```

现在您的服务已经从零开始重新部署，使用最新的修复代码，HTTPS问题应该完全解决！

---

**💡 重要提示**：这是完全清理重建的方案，会删除所有旧文件并重新开始。所有的SSL和配置问题都会得到彻底解决。
