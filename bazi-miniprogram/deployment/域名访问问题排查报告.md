# 域名访问问题排查报告

## 📊 问题概述

**问题现象**：部署成功后，无法通过域名访问API接口 `https://api.bazi365.top/health`

**排查时间**：2025-10-11 10:00

**最终结论**：域名未备案导致腾讯云阻断访问

---

## 🔍 详细排查过程

### 1. DNS解析检查
```bash
$ nslookup api.bazi365.top
Server: 223.5.5.5
Address: 223.5.5.5#53

Non-authoritative answer:
Name: api.bazi365.top
Address: 119.91.146.128
```
**结果**：✅ DNS解析正常，域名正确指向服务器IP

### 2. 服务器连通性测试
```bash
$ ping -c 3 119.91.146.128
PING 119.91.146.128 (119.91.146.128): 56 data bytes
64 bytes from 119.91.146.128: icmp_seq=0 ttl=49 time=18.144 ms
64 bytes from 119.91.146.128: icmp_seq=1 ttl=49 time=17.930 ms
64 bytes from 119.91.146.128: icmp_seq=2 ttl=49 time=18.382 ms

--- 119.91.146.128 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
```
**结果**：✅ 服务器连通性正常，延迟18ms

### 3. 直接IP访问测试
```bash
$ curl http://119.91.146.128:8001/health
{
  "status":"healthy",
  "environment":"development",
  "version":"2.0.0-real",
  "local_ip":"10.1.20.2",
  "timestamp":"2025-10-11T10:00:20.353386",
  "dependencies":{
    "fastapi":"✅ 已安装",
    "uvicorn":"✅ 已安装",
    "pydantic":"✅ 已安装",
    "pillow":"✅ 已安装",
    "cors":"✅ 已配置",
    "sxtwl":"✅ 已安装",
    "zhdate":"✅ 已安装",
    "algorithms":"✅ 已启用"
  }
}
```
**结果**：✅ API服务运行完全正常

### 4. HTTPS域名访问测试
```bash
$ curl https://api.bazi365.top/health
curl: (7) Failed to connect to api.bazi365.top port 443 after 3193 ms: Couldn't connect to server
```
**结果**：❌ HTTPS端口443无法连接

### 5. HTTP域名访问测试
```bash
$ curl -v http://api.bazi365.top/health
* Host api.bazi365.top:80 was resolved.
* IPv4: 119.91.146.128
* Trying 119.91.146.128:80...
* Connected to api.bazi365.top (119.91.146.128) port 80
> GET /health HTTP/1.1
> Host: api.bazi365.top
> User-Agent: curl/8.7.1
> Accept: */*
>
< HTTP/1.1 302 OK
< Connection: Keep-Alive
< Location: https://dnspod.qcloud.com/static/webblock.html?d=api.bazi365.top
```
**结果**：❌ 被重定向到腾讯云域名阻断页面

### 6. 主域名访问测试
```bash
$ curl -v http://bazi365.top
< HTTP/1.1 302 OK
< Location: https://dnspod.qcloud.com/static/webblock.html?d=bazi365.top
```
**结果**：❌ 主域名同样被阻断

---

## 🎯 问题根本原因

**域名未在工信部备案**，导致腾讯云服务器自动阻断所有通过域名的HTTP/HTTPS访问请求。

### 阻断机制说明
- 腾讯云检测到未备案域名访问
- 自动返回302重定向到阻断页面
- 重定向地址：`https://dnspod.qcloud.com/static/webblock.html?d=域名`
- 直接IP访问不受影响

---

## 🛠️ 解决方案

### 方案一：域名备案（推荐）

#### 1. 备案流程
1. **登录腾讯云控制台**
   - 进入"域名与网站" → "备案管理"
   - 点击"首次备案"

2. **填写备案信息**
   - 主体信息：个人/企业资料
   - 网站信息：网站名称、用途等
   - 上传身份证明材料

3. **等待审核**
   - 腾讯云初审：1-3个工作日
   - 管局审核：5-20个工作日
   - 总计约7-20个工作日

#### 2. 备案完成后
- 域名访问将自动恢复正常
- 可以正常使用HTTPS
- SSL证书功能完全可用

### 方案二：临时解决方案

#### 1. 直接IP访问
```bash
# 当前可用的API访问方式
curl http://119.91.146.128:8001/health
```

#### 2. 修改小程序配置
在小程序中临时修改API地址：
```javascript
// 临时API配置
const API_BASE_URL = 'http://119.91.146.128:8001';

// 备案完成后改回
// const API_BASE_URL = 'https://api.bazi365.top';
```

#### 3. 注意事项
- 小程序可能对IP访问有限制
- HTTPS功能暂时不可用
- 需要在小程序后台配置IP白名单

### 方案三：迁移境外服务器

#### 1. 优点
- 无需备案即可使用域名
- SSL证书正常工作
- 完整功能可用

#### 2. 缺点
- 访问速度可能略慢
- 需要重新部署
- 可能增加成本

#### 3. 推荐境外服务器
- 腾讯云香港
- 阿里云香港
- AWS新加坡
- Vultr日本

---

## 📋 当前状态总结

### ✅ 正常功能
- [x] 服务器部署成功
- [x] API服务运行正常
- [x] 所有后端功能可用
- [x] 直接IP访问正常
- [x] DNS解析配置正确

### ❌ 受影响功能
- [ ] 域名HTTP访问（被阻断）
- [ ] 域名HTTPS访问（被阻断）  
- [ ] SSL证书功能（无法验证）
- [ ] 小程序正常域名调用

### 📊 服务可用性
- **API服务**：100% 可用（通过IP访问）
- **域名访问**：0% 可用（需要备案）
- **功能完整性**：100% 正常

---

## 🎯 下一步行动计划

### 立即可做
1. **确认服务正常**：定期检查 `http://119.91.146.128:8001/health`
2. **小程序调试**：使用IP地址进行开发测试
3. **准备备案材料**：身份证、营业执照等

### 备案期间
1. **继续开发**：使用IP访问进行功能开发
2. **准备上线**：等待备案完成
3. **监控服务**：确保服务稳定运行

### 备案完成后
1. **验证域名访问**：测试HTTP/HTTPS访问
2. **更新小程序配置**：切换到正式域名
3. **申请SSL证书**：如果需要重新申请
4. **全面测试**：确保所有功能正常

---

## 📞 联系信息

**技术支持**：如有问题可随时联系
**文档更新**：2025-10-11 10:11
**下次检查**：备案提交后跟进进度

---

## 附录：常用检查命令

```bash
# 检查DNS解析
nslookup api.bazi365.top

# 检查服务器连通性
ping -c 3 119.91.146.128

# 检查API服务状态
curl http://119.91.146.128:8001/health

# 检查域名访问状态
curl -v http://api.bazi365.top/health

# 检查HTTPS访问
curl https://api.bazi365.top/health
